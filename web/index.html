<!DOCTYPE html>
<html>
    <head>
        <script src="autobahn.min.js"></script>
        <script src="jquery-1.7.2.js"></script>
        <script src="functional.js"></script>
        <script>
// <![CDATA[
        // WAMP session object
        var sess;
        var wsuri;

        var g_login = null;
        var g_role = null;
        var g_gameuri = null;
        var g_timer = null;
        var g_timeout = null;
        var g_state = null;
        var g_playermap = null;
        var g_imgprefix = null;

        // Currently in the process of joining a game
        var g_joining = false;

        // currently detailed card id
        var g_detail_id = null;

        // List of available cards
        var g_cards_available = [];
        var g_cards_decknames = [];
        var g_cards_decks = {};
        var g_cards_available_map = {};

        window.onload = function() {

            if (window.location.protocol === "file:") {
                wsuri = "ws://localhost:9000";
            } else {
                wsuri = "ws://" + window.location.hostname + ":9000";
            }

            // connect to WAMP server
            ab.connect(wsuri,

               // WAMP session was established
               function (session) {

                  sess = session;
                  console.log("Connected!");

                  sess.subscribe("http://manaclash.org/users", onUsers);
                  sess.subscribe("http://manaclash.org/games", onGames);

                  cardsSetup();
               },

               // WAMP session is gone
               function (code, reason) {
                  sess = null;
                  alert(reason);
               }
            );

            $("#timer").click(function(event) {
                stopTimer();
            });
            $("#timer").attr("disabled", "disabled");

            $("#query_button").click(function(event) {
                onQueryButton();
            });

            $("#game_messages_expand").click(function(event) {
                expandLog();
            });

            $("#game_messages_send").click(function(event) {
                sendMessage();
            });

            view("view_lobby");
            showZone(null);

            // clear the log
            $("#messages").empty();

            if(typeof(Storage)!=="undefined") {
                g_imgprefix = localStorage.imgprefix;
                $("#settings_imgprefix").val(g_imgprefix);
            }

        };

        function subscribeGame(gameUri) {
            sess.subscribe(gameUri + "/state", onGame);
            sess.subscribe(gameUri + "/zoneTransfer", onLogZoneTransfer);
            sess.subscribe(gameUri + "/action", onLogAction);
            sess.subscribe(gameUri + "/number", onLogNumber);
            sess.subscribe(gameUri + "/message", onLogMessage);

            sess.subscribe(gameUri + "/player/online", onPlayerOnline);
            sess.subscribe(gameUri + "/player/offline", onPlayerOffline);

        }

        function onUsers(topicUri, users) {
            $("#userlist").empty();
            for (var i = 0; i < users.length; i++) {
                $("#userlist").append ("<p>" + users[i] + "</p>");
            }
        }

        function onGames(gamesUri, games) {
            $("#gameslist").empty();

            for (var i = 0; i < games.length; i++) {
                var gameElement = $("<div>" + games[i].id + "</div>").appendTo($("#gameslist"));

                var players = 0;
                var have_me = false;
                for (var j = 0; j < games[i].players.length; j++) {
                    if (games[i].players[j].role == "player1" || games[i].players[j].role == "player2") {
                        ++players;
                    }
                    var playerElement = $("<div>" + games[i].players[j].login + " (" + games[i].players[j].role + ")</div>").appendTo(gameElement);

                    if (games[i].players[j].login == g_login) {
                        have_me = true;
                    }

                    if (have_me && !(g_gameuri == games[i].uri && g_role == games[i].players[j].role) && !g_joining) {
                        $("<button>Takeover</button>").appendTo(playerElement).click({"game_id":games[i].id, "role":games[i].players[j].role}, function(event) {
                            sess.call("http://manaclash.org/takeover", event.data.game_id, event.data.role).then(
                                function(ret) {
                                    var uri = ret[0];
                                    var role = ret[1];
                                    subscribeGame(uri);
                                    g_role = role;
                                    g_gameuri = uri;
                                    sess.call("http://manaclash.org/refresh")
                                }
                            );
                        });
                    }
                }

                if (players < 2 && !have_me && g_login != null) {
                    $("<button>Join</button>").appendTo(gameElement).click({"game_id":games[i].id}, function(event) {
                        g_joining = true;

                        var deckname = $("#cards_decks").val();
                        var deck = g_cards_decks[deckname];

                        sess.call("http://manaclash.org/games/join", event.data.game_id, deck).then(
                            function(ret) {
                                if(ret != null) {
                                    var uri = ret[0];
                                    var role = ret[1];
                                    subscribeGame(uri);
                                    g_role = role;
                                    g_gameuri = uri;
                                }
                                g_joining = false;
                                sess.call("http://manaclash.org/refresh")
                            }
                        );
                    });
                }
            }
        }

        function onPlayerOffline(uri, message) {
            var login = message[0];
            var role = message[1];

            var msg = appendLog("" + login + " goes offline");

            if (role == g_role) {
                msg.addClass("player_message");
            }
            else {
                msg.addClass("opponent_message");
            }
        }

        function onPlayerOnline(uri, message) {
            var login = message[0];
            var role = message[1];

            var msg = appendLog("" + login + " back online");

            if (role == g_role) {
                msg.addClass("player_message");
            }
            else {
                msg.addClass("opponent_message");
            }

        }

        function login() {
            g_login = $("#username").val();
            sess.call("http://manaclash.org/login", $("#username").val(), $("#password").val()).then(
                function(result) {
                     if(!result) {
                        alert("Login failed!");
                        g_login = null;
                     }
                },
                function(){ alert("failed to login!"); }
            );
        }

        function onGame(gameUri, state) {
            /* Check the game URI */
            if (gameUri.slice(0, g_gameuri.length) == g_gameuri) {
                var event = gameUri.slice(g_gameuri.length);
                if (event == "/state") {
                    onState(state);
                }
            }
        }

        /*
            Renders the card elements
            objSpan, the root span of the card
            obj the object representing the card, as got from the server
        */
        function displayCardContents(objSpan, obj) {
            var headerSpan = $("<span class='header'/>");
            headerSpan.appendTo(objSpan);

            var titleSpan = $("<span class='title'></span>");
            titleSpan.append(obj.title);
            titleSpan.appendTo(headerSpan);
           
            var costSpan = $("<span class='manacost'></span>");
            costSpan.append(obj.manacost);
            costSpan.appendTo(headerSpan);

            if (obj.power != null) {
                var powerSpan = $("<span class='power'></span>");
                powerSpan.append(obj.power + "/" + obj.toughness);
                powerSpan.appendTo(objSpan);
            }

            var bodySpan = $("<span class='body'/>");
            bodySpan.appendTo(objSpan);

            var typeSpan = $("<span class='types'></span>");
            typeSpan.append(obj.supertypes.join(" "));
            typeSpan.append(" ");
            typeSpan.append(obj.types.join(" "));

            if (obj.subtypes.length > 0) {
                typeSpan.append(" &ndash; ");
            }

            typeSpan.append(obj.subtypes.join(" "));
            typeSpan.appendTo(bodySpan);

            var tagsSpan = $("<span class='tags'></span>");
            tagsSpan.append(obj.tags.join(" "));
            tagsSpan.appendTo(bodySpan);

            objSpan.append(" ");

            var textSpan = $("<span class='text'></span>");
            textSpan.append(obj.text);
            textSpan.appendTo(bodySpan);
       }

        /*
            Creates and returns a card <span/> from the server card object
            Also creates a "card_detail" span for this card and appends it hidden into the card_detail container
        */
        function displayCard(obj) {

            var objSpan = $("<span class='" + (obj.tapped ? "tapped_small" : "card_small") + "' id='obj_" + obj.id + "'></span>");

            var fulltext =  "#" + obj.id + " " + obj.title + " " + obj.manacost + " " + obj.supertypes.join(" ") + " " + obj.types.join(" ");
            if (obj.subtypes.length > 0) {
                fulltext += " - ";
            }
            fulltext += obj.subtypes.join(" ") + " ";

            fulltext += obj.text;

            if (obj.power != null) {
                fulltext += " " + obj.power + "/" + obj.toughness;
            }

            objSpan.attr("title", fulltext);

            if (g_imgprefix != null && g_imgprefix != "") {
                var img = $("<img/>");
                var imgstring = obj.title + ".jpg";
                img.attr("src", g_imgprefix + imgstring);
                img.attr("alt", "");

                img.appendTo(objSpan);
            }
            else {
                displayCardContents(objSpan, obj);
            }

            var detailSpan = $("<span class='card_detail' id='detail_" + obj.id + "'></span>");
            displayCardContents(detailSpan, obj);
            detailSpan.hide();
            detailSpan.appendTo($("#card_details"));

            objSpan.hover(
                function(id) {
                    if (g_detail_id != null) {
                        $("#detail_" + g_detail_id).hide();
                    }
                    $("#detail_" + id).show();
                    g_detail_id = id;
                }.partial(obj.id),
                function(id) {
                    $("#detail_" + id).hide();
                    g_detail_id = null;
                }.partial(obj.id)
            );

            return objSpan;
        }

        function displayZone(state_zone, div) {
            for (var i = 0; i < state_zone.length; ++i) {
                var obj = state_zone[i];

                var objSpan = displayCard(obj);
                objSpan.appendTo(div);
            }
        }

        function onState(state) {

            g_state = state;

            var view = $("#table");
            view.empty();

            $('#text').empty();
            // is it our turn?
            if (g_role == state["player"]) {
                $("#text").append(state["text"]);
            }
            else {
                $("#text").append("Waiting on " + state["player"]);
            }


            $("#phase").empty();
            $("#phase").append(state["phase"]);

            $("#step").empty();
            $("#step").append(state["step"]);

            $("#card_details").empty();

            var in_play = [];
            var hands = [];
            var players = [];
            // playerN -> player|opponent
            var rolemap = {};
            
            // playerN -> player object
            g_playermap = {};

            if (g_role == "player1") {
                players.push("player");
                players.push("opponent");
            }
            else {
                players.push("opponent");
                players.push("player");
            }

            player_divs = [];
           
            for (var i = 0; i < players.length; ++i) {
                player_divs[players[i]] = $("<div><h3>" + state["players"][i].name + "</h3></div>");
                rolemap["player" + (i+1)] = players[i];
            }

            var stack = $("<div>Stack</div>");
            displayZone(state["stack"], stack);

            player_divs["opponent"].appendTo(view);
            stack.appendTo(view);
            player_divs["player"].appendTo(view);

            for (var i = 0; i < players.length; ++i) {
                in_play[players[i]] = $("<div>In play</div>").appendTo(player_divs[players[i]]);
                hands[players[i]] = $("<div>Hand</div>").appendTo(player_divs[players[i]]);
            }           

            for (var i = 0; i < state["in_play"].length; ++i) {
                var obj = state["in_play"][i];

                if (obj.controller != null) {
                    objSpan = displayCard(obj);
                    objSpan.appendTo(in_play[rolemap[obj.controller]]);
                }
            }

            for (var i = 0; i < state["players"].length; ++i) {
                var player = state["players"][i];

                g_playermap["player" + (i+1)] = player;

                $("#" + rolemap[player.role] + "_name").empty(); 
                $("#" + rolemap[player.role] + "_name").append(player.name);

                $("#" + rolemap[player.role] + "_hand").empty(); 
                $("#" + rolemap[player.role] + "_hand").append(player.hand.length);

                $("#" + rolemap[player.role] + "_library").empty(); 
                $("#" + rolemap[player.role] + "_library").append(player.library.length);

                $("#" + rolemap[player.role] + "_graveyard").empty(); 
                $("#" + rolemap[player.role] + "_graveyard").append(player.graveyard.length);

                $("#" + rolemap[player.role] + "_life").empty(); 
                $("#" + rolemap[player.role] + "_life").append(player.life);

                $("#" + rolemap[player.role] + "_manapool").empty(); 
                $("#" + rolemap[player.role] + "_manapool").append(player.manapool);

                $("#" + rolemap[player.role] + "_graveyard_zone").empty(); 
                $("#" + rolemap[player.role] + "_library_zone").empty(); 

                displayZone(player["graveyard"], $("#" + rolemap[player.role] + "_graveyard_zone"));
                displayZone(player["library"], $("#" + rolemap[player.role] + "_library_zone"));
                displayZone(player["hand"], hands[players[i]]);
            }

            $("#turn").empty();
            $("#turn").append(g_playermap[state["turn"]].name);

            var actions_div = $("#actions");
            actions_div.empty();

            var query = $("#query");
            query.hide();

            var pass = $("#pass");
            pass.attr("disabled", "disabled");

            appendLog("" + g_playermap[state["player"]].name + ", " + state["text"]);

            if (g_role == state["player"]) {
                if (state["actions"] != null) {

                    var autopass = true;
                    var haspass = false;

                    if (state["text"] != "You have priority") {
                        autopass = false;
                    }

                    for (var i = 0; i < state["actions"].length; ++i) {
                        var action = state["actions"][i];
                        if (action["object"] == null) {

                            if (action["text"] != "Pass") {
                                autopass = false;
                                var action_span = $("<button></button>").appendTo(actions_div);
                                action_span.append(action["text"]);
                                action_span.addClass('action_button');
                                action_span.click({'i':i}, function(event) {
                                    stopTimer();
                                    sess.publish(g_gameuri, event.data.i);
                                });
                            }
                            else {
                                haspass = true;
                                pass.removeAttr("disabled");
                            }
                        }
                        else {

                            if (action["manaability"] == null || action["manaability"] == false) {
                                autopass = false;
                            }

                            var action_obj = $('#obj_' + action["object"]);
                            action_obj.addClass('action');
                            action_obj.click({'i':i}, function(event) {
                                stopTimer();
                                sess.publish(g_gameuri, event.data.i);
                            });
                        }
                    }

                    // auto select no more attackers if none available
                    if (state["actions"].length == 1 && state["actions"][0]["text"] == "No more attackers" && state["step"] == "declare attackers" && state["text"] == "Select attackers") {
                        autopass = true;
                    }

                    // auto select no more blockers if none available
                    if (state["actions"].length == 1 && state["actions"][0]["text"] == "No more blockers" && state["step"] == "declare blockers" && state["text"] == "Select blockers") {
                        autopass = true;
                    }

                    if (autopass) {
                        sess.publish(g_gameuri, 0);
                    }
                    else {
                        if (state["text"] == "You have priority" && haspass && !(state["turn"] == g_role && (state["phase"] == "precombat main" || state["phase"] == "postcombat main"))) {
                            g_timeout = 5;
                            g_timer = setTimeout('onTimer()', 1000);

                            $("#timer").empty();
                            $("#timer").append(g_timeout);

                            $("#timer").removeAttr("disabled");
                        }
                    }
                }
                else if (state["query"] != null) {
                    $("#query_text").empty();
                    $("#query_text").append(state["query"]);
                    $("#query_input").val("");
                    query.show();
                }
            } 
        }

        function onPass() {
            stopTimer();
            sess.publish(g_gameuri, 0);
        }

        function onQueryButton() {
            sess.publish(g_gameuri, $("#query_input").val());
        }

        function stopTimer() {
            if (g_timer != null) {
                clearTimeout(g_timer);
            }
            g_timer = null;
            g_timeout = null;
            $("#timer").attr("disabled", "disabled");

            $("#timer").empty();
            $("#timer").append("Auto Pass");
        }

        function onTimer() {

            if (g_timeout == null) {
                return;
            }

            g_timeout--;

            $("#timer").empty();
            $("#timer").append(g_timeout);

            if (g_timeout <= 0) {
                sess.publish(g_gameuri, 0);
                stopTimer();
            }
            else {
                setTimeout('onTimer()', 1000);
            }
        }

        function view(v) {
            $("#view_lobby").hide();
            $("#view_game").hide();
            $("#view_cards").hide();
            $("#view_settings").hide();

            $("#" + v).show();
        }

        function showZone(zone) {
            $("#player_graveyard_zone").hide();
            $("#player_library_zone").hide();
            $("#opponent_graveyard_zone").hide();
            $("#opponent_library_zone").hide();

            if (zone != null) {
                zone.show();
                $("#zones").show();
            }
            else {
                $("#zones").hide();
            }
        }

        // Logs

        function appendLog(log) {
            var msg = $("<div class='message'></div>");
            msg.append(log);
            msg.appendTo($("#messages"));

            $("#messages").scrollTop($("#messages")[0].scrollHeight);

            return msg;
        }

        function onLogZoneTransfer(uri, zoneTransfer) {
            appendLog("" + zoneTransfer[2].title + " moved from " + zoneTransfer[0] + " to " + zoneTransfer[1]);
        }

        function onLogAction(uri, actionMessage) {
            appendLog("" + g_playermap[actionMessage[0]].name + " " + actionMessage[1]["text"]);
        }

        function onLogNumber(uri, numberMessage) {
            appendLog("" + g_playermap[actionMessage[0]].name + " " + actionMessage[1]);
        }

        /* Messages sent by players */
        function onLogMessage(uri, message) {
            var msg = appendLog("" + g_playermap[message[0]].name + " " + message[1]);
            if (message[0] == g_role) {
                msg.addClass("player_message");
            }
            else {
                msg.addClass("opponent_message");
            }
        }

        function sendMessage() {
            sess.publish(g_gameuri + "/message", [g_role, $("#game_messages_input").val()], false);
        }

        function expandLog() {
            $("#game_messages").toggleClass("game_messages_expanded");
            $("#messages").scrollTop($("#messages")[0].scrollHeight);
        }

        function settingsSave() {
            g_imgprefix = $("#settings_imgprefix").val();

            if(typeof(Storage)!=="undefined") {
                localStorage.imgprefix = g_imgprefix;
            }
        }

        /* Stores the current decks into local storage */
        function cardsSave() {
            if(typeof(Storage)!=="undefined") {

                localStorage.cardsDeckname = $("#cards_decks").val();
                var decks = "";
                for (var i = 0; i < g_cards_decknames.length; i++) {
                    decks += "n" + g_cards_decknames[i] + "\n";
                    for (var j = 0; j < g_cards_decks[g_cards_decknames[i]].length; j++) {
                        decks += "c" + g_cards_decks[g_cards_decknames[i]][j][0] + " " + g_cards_decks[g_cards_decknames[i]][j][1] + "\n";
                    }
                }

                localStorage.cardsDecks = decks;
            }
        }

        /* Reads available cards from the server and loads decks from the local storage */
        function cardsSetup() {
            sess.call("http://manaclash.org/getAvailableCards").then(
                function(result) {
                    g_cards_available = result;

                    $("#cards_available").empty();

                    for (var i = 0; i < g_cards_available.length; i++) {
                        var card = g_cards_available[i];
                        $("<option value=\"" + card.name + "\">" + card.name +  "</option>").appendTo($("#cards_available"));

                        g_cards_available_map[card.name] = card;
                    }

                    if(typeof(Storage)!=="undefined") {
                        var decks = localStorage.cardsDecks;
                        if (decks != null) {
                            decks = decks.split("\n");
                            var deck = [];
                            var deckname = null;
                            for (var i = 0; i < decks.length; i++) {
                                if (decks[i] != "") {
                                    if (decks[i][0] == "n") {
                                        if (deck.length > 0) {
                                            g_cards_decknames.push(deckname);
                                            g_cards_decks[deckname] = deck;
                                            deck = [];
                                            deckname = null;
                                        }
                                        deckname = decks[i].substr(1);
                                    }
                                    else if (decks[i][0] == "c") {
                                        var s = decks[i].substr(1);
                                        var num = s.split(" ", 1);
                                        var name = $.trim(s.substr(num.length + 1));
                                        deck.push([parseInt(num), name]);
                                    }
                                }
                            }

                            if (deck.length > 0) {
                                g_cards_decknames.push(deckname);
                                g_cards_decks[deckname] = deck;
                            }
                        }

                        $("#cards_decks").empty();
                        for (var i = 0; i < g_cards_decknames.length; i++) {
                            $("<option>" + g_cards_decknames[i] + "</option>").appendTo($("#cards_decks"));
                        }
                        $("#cards_decks").val(localStorage.cardsDeckname);

                        cardsSelectDeck();
                    }
                },
                function(){ alert("failed to fetch available cards!"); }
            );
        }

        function cardsDeckNew() {
            var deckname = $("#cards_deckname").val();
            g_cards_decknames.push(deckname);
            g_cards_decks[deckname] = [];

            $("#cards_decks").empty();
            for (var i = 0; i < g_cards_decknames.length; i++) {
                $("<option>" + g_cards_decknames[i] + "</option>").appendTo($("#cards_decks"));
            }

            $("#cards_decks").val(deckname);

            $("#cards_deck").empty();

            cardsSave();
        }

        function cardsDeckRename() {
        }

        function cardsDeckDelete() {

            var deckname = $("#cards_decks").val();
            
            var i = g_cards_decknames.indexOf(deckname);
            g_cards_decknames.splice(i, 1);
            g_cards_decks[deckname] = null;

            $("#cards_decks").empty();
            for (var i = 0; i < g_cards_decknames.length; i++) {
                $("<option>" + g_cards_decknames[i] + "</option>").appendTo($("#cards_decks"));
            }

            $("#cards_deck").empty();

            cardsSave();
        }

        /** Adds selected cards form the "available" list to the current deck */
        function cardsAdd() {
            var deckname = $("#cards_decks").val();
            var deck = g_cards_decks[deckname];

            var selected = $("#cards_available").val();
            if (selected != null) {
                for (var i = 0; i < selected.length; i++) {
                    var found = false;
                    for (var j = 0; j < deck.length; ++j) {
                        var n = deck[j][0];
                        var name = deck[j][1];
                        if (name == selected[i]) {
                            deck[j][0] = n + 1;
                            var option = $("#cards_deck>option[value=\""+ name +"\"]");
                            option.empty();
                            option.append(deck[j][0] + " " + deck[j][1]);
                            found = true;
                        }
                    }

                    if (!found) {
                        /* No such card in the deck yet */
                        deck.push([1, selected[i]]);
                        deck.sort(function (a,b) { return a[1].localeCompare(b[1]);} );

                        $("#cards_deck").empty();
                        for (var j = 0; j < deck.length; j++) {
                            var option = $("<option value=\"" + deck[j][1] + "\"></option>").appendTo($("#cards_deck"));
                            option.append("" + deck[j][0] + " " + deck[j][1]);
                        }
                    }
                }

                cardsSave();
            }
        }

        /** Removes selected cards from the current deck */
        function cardsRemove() {
            var deckname = $("#cards_decks").val();
            var deck = g_cards_decks[deckname];

            var selected = $("#cards_deck").val();
            if (selected != null) {
                for (var i = 0; i < selected.length; i++) {
                    for (var j = 0; j < deck.length; j++) {
                        if (deck[j][1] == selected[i]) {
                            deck[j][0] = deck[j][0] - 1;

                            var option = $("#cards_deck>option[value=\""+ selected[i] +"\"]");

                            if (deck[j][0] <= 0) {
                                /* We have removed all cards of this type, remove the whole entry */
                                deck.splice(j, 1);
                                option.remove();
                                break;
                            }
                            else {
                                option.empty();
                                option.append(deck[j][0] + " " + deck[j][1]);
                            }
                        }
                    }
                }

                cardsSave();
            }
        }

        function cardsSelectDeck() {
            var deckname = $("#cards_decks").val();
            var deck = g_cards_decks[deckname];

            $("#cards_deck").empty();

            for (var i = 0; i < deck.length; i++) {
                var option = $("<option value=\"" + deck[i][1] + "\"></option>").appendTo($("#cards_deck"));
                option.append("" + deck[i][0] + " " + deck[i][1]);
            }

            cardsSave();
        }

        function cardsAvailableChanged() {
            $("#cards_detail").empty();
            var selected = $("#cards_available").val();
            
            if (selected != null) {
                for (var i = 0; i < selected.length; i++) {
                    var card = g_cards_available_map[selected[i]];

                    if (g_imgprefix != null && g_imgprefix != "") {
                        var img = $("<img/>");
                        var imgstring = card.name + ".jpg";
                        img.attr("src", g_imgprefix + imgstring);
                        img.attr("alt", card.text);
        
                        img.appendTo($("#cards_detail"));
                    }
                    else {
                        var div = $("<div></div>");
                        div.append(card.text);
                        div.appendTo($("#cards_detail"));
                    }
                }
            }
        }

        function cardsDeckChanged() {
            $("#cards_detail").empty();
            var selected = $("#cards_deck").val();
            
            if (selected != null) {
                for (var i = 0; i < selected.length; i++) {
                    var card = g_cards_available_map[selected[i]];

                    if (g_imgprefix != null && g_imgprefix != "") {
                        var img = $("<img/>");
                        var imgstring = card.name + ".jpg";
                        img.attr("src", g_imgprefix + imgstring);
                        img.attr("alt", card.text);
        
                        img.appendTo($("#cards_detail"));
                    }
                    else {
                        var div = $("<div></div>");
                        div.append(card.text);
                        div.appendTo($("#cards_detail"));
                    }
                }
            }

        }

// ]]>
    </script>
    <style>
.card {
    display: inline-block;
    width: 200px;
    height: 285px;
    cursor: pointer;
    vertical-align: top;
}

.card_small {
    position: relative;
    display: inline-block;
    width: 100px;
    height: 142px;
    cursor: pointer;
    vertical-align: top;
    overflow: hidden;
}

.card_small > img {
   position: absolute;
   width: 100px;
   height: 142px;
   z-index: 2;
   border-radius: 8px;
}

.tapped {
    width: 285px;
    height: 200px;
    display: inline-block;
    cursor: pointer;
    vertical-align: top;
}

.tapped_small {
    position: relative;
    width: 142px;
    height: 100px;
    display: inline-block;
    cursor: pointer;
    vertical-align: top;
    overflow: hidden;
}

.tapped_small > img {
   position: absolute;
   width: 100px;
   height: 142px;
   z-index: 2;
  -webkit-transform: rotate(90deg) translate(-21px, -21px);
  -moz-transform: rotate(90deg) translate(-21px, -21px);
   border-radius: 8px;
}

.tapped .header {
    position: absolute;
    display: inline-block;
    -webkit-transform: rotate(90deg) translate(90px, -175px);
    -moz-transform: rotate(90deg) translate(90px, -175px);
    font-size: 12px;
    width: 200px;
    height: 20px;
}

.tapped_small .header {
    position: absolute;
    display: inline-block;
    -webkit-transform: rotate(90deg) translate(45px, -90px);
    -moz-transform: rotate(90deg) translate(45px, -90px);
    font-size: 8px;
    width: 100px;
    height: 10px;
}

.tapped > .header > .title {
    position: absolute;
    text-align: left;
    top: 0px;
    left: 0px;
}

.tapped_small > .header > .title {
    position: absolute;
    text-align: left;
    top: 0px;
    left: 0px;
}

.tapped > .header > .manacost {
    position: absolute;
    text-align: right;
    top: 0px;
    right: 0px;
}

.tapped_small > .header > .manacost {
    position: absolute;
    text-align: right;
    top: 0px;
    right: 0px;
}

.tapped_small > .power {
    display: block;
    position: relative;
    font-size: 10px;
    height: 12px;
    width: 20px;
    left: 0px;
    top: 88px;
    background: inherit;
    z-index: 1;
    text-align: left;
}

.tapped > .body {
    position: absolute;
    width: 265px;
}

.tapped_small > .body {
    display: block;
    position: absolute;
    top: 0px;
    width: 132px;
    font-size: 10px;
}

.types {
    display: block;
}

.tags {
    display: block;
}

.text {
    display: block;
}

.card > .header {
    position: absolute;
    font-size: 12px;
    height: 20px;
    width: 200px;
}

.card_small > .header {
    position: absolute;
    font-size: 8px;
    height: 10px;
    width: 100px;
}

.card > .header > .title {
    position: absolute;
    text-align: left;
    top: 0px;
    left: 0px;
}

.card_small > .header > .title {
    position: absolute;
    text-align: left;
    top: 0px;
    left: 0px;
}

.card > .header > .manacost {
    position: absolute;
    text-align: right;
    top: 0px;
    right: 0px;
}

.card_small > .header > .manacost {
    position: absolute;
    text-align: right;
    top: 0px;
    right: 0px;
}

.card > .body {
    display: block;
    position: relative;
    top: 20px;
    width: 200px;
}

.card_small > .body {
    display: block;
    position: absolute;
    top: 10px;
    left: 0px;
    width: 100px;
    height: 100px;
    font-size: 10px;
}

.card_small > .power {
    display: block;
    position: relative;
    font-size: 10px;
    height: 12px;
    width: 20px;
    left: 80px;
    top: 130px;
    background: inherit;
    z-index: 1;
    text-align: right;
}

.action {
   border: solid 2px yellow;
}

.action_button {
   display:block;
   width: 200px;
}

#table {
  position:absolute;
  left: 200px;
  top:20px;
  bottom:100px;
  right:5px;
  background: #336633;
  overflow: auto;
}

#game_messages {
    position: absolute;
    bottom:0px;
    left: 200px;
    right:5px;
    height:100px;
    background: #ffcccc;
    z-index:10;
}

.game_messages_expanded {
    position: absolute;
    bottom:0px;
    left: 200px;
    right:5px;
    top:100px;
    height: auto !important;
    background: #ffcccc;
}

#game_messages_form {
    position:absolute;
    bottom:0px;
    height: 32px;
}

#game_messages > #messages {
  position:absolute;
  overflow: auto;
  bottom: 32px;
  top:0px;
  right:0px;
  left:0px;
}

.player_message {
  color: green;
}

.opponent_message {
  color: red;
}

#status {
  width: 200px;
}

#timer {
 width: 200px;
}

#pass {
 width: 200px;
}

#zones {
    position:absolute;
    left:300px;
    top:100px;
    right:100px;
    bottom:100px;
    z-index: 5;
    background: #aaccaa;
    border: 1px solid black;
    overflow: auto;
}

#card_details {
    margin-top: 1em;
}

.card_detail > .power {
    display: block;
}

.card_detail > .header {
    display: block;
}

.card_detail .title {
    display: block;
}

.card_detail .manacost {
    display: block;
}

.view {
    position: absolute;
    left:8px;
    right:8px;
    top:32px;
    bottom:8px;

}

#cards_available {
    position:absolute;
    left:0x;
    top:100px;
    width:200px;
    bottom:0px;
}

#cards_buttons {
    position: absolute;
    text-align: center;
    left:200px;
    top:100px;
    width:100px;
}

#cards_deck {
    position:absolute;
    left:300px;
    top:100px;
    width:200px;
    bottom:0px;
}

#cards_detail {
    position:absolute;
    left:550px;
    top:100px;
}

body {
  width: 100%;
  height: 100%;
  padding: 0px;
  margin: 0px;
}

    </style>
    </head>
    <body>

        <div>
            <button onclick="view('view_lobby');">Lobby</button> | <button onclick="view('view_cards');">Cards</button> | <button onclick="view('view_game');">Game</button> | <button onclick="view('view_settings');">Settings</button>
        </div>

        <div class="view" id="view_lobby">

            <h1>ManaClash</h1>

            <h3>Users</h3>
            <div id="userlist"></div>

            <h3>Games</h3>
            <div id="gameslist"></div>

            <div id="login">
                Username: <input id="username" name="username"/>
                Password: <input id="password" name="password" type="password"/>
                <button onclick="login();">Login</button>
            </div>
        </div>

        <div class="view" id="view_game">
            <h3>Game</h3>

            <div id="status">
                <div>Turn: <span id="turn"></span></div>
                <div>Phase: <span id="phase"></span></div>
                <div>Step: <span id="step"></span></div>

                <div id="text"></div>

                <div><button id="timer">Auto Pass</button></div>
                <div><button id="pass" onclick="onPass();">Pass</button></div>

                <div id="actions">
                    <button class="action_button">Action 1</button>
                    <button class="action_button">Action 2</button>
                    <button class="action_button">Action 2</button>
                </div>

                <div id="query">
                    <div id="query_text"></div>
                    <input id="query_input"/>
                    <div>
                        <button id="query_button">Answer</button>
                    </div>
                </div>

                <div id="opponent">
                    <h3 id="opponent_name"></h3>
                    <div>Life: <span id="opponent_life"></span></div>
                    <div>Manapool: <span id="opponent_manapool"></span></div>
                    <div>Hand: <span id="opponent_hand"></span></div>
                    <div onclick="showZone($('#opponent_library_zone'));">Library: <span id="opponent_library"></span></div>
                    <div onclick="showZone($('#opponent_graveyard_zone'));">Graveyard:<span id="opponent_graveyard"></span></div>
                </div>

                <div id="player">
                    <h3 id="player_name"></h3>
                    <div>Life: <span id="player_life"></span></div>
                    <div>Manapool: <span id="player_manapool"></span></div>
                    <div>Hand: <span id="player_hand"></span></div>
                    <div onclick="showZone($('#player_library_zone'));">Library: <span id="player_library"></span></div>
                    <div onclick="showZone($('#player_graveyard_zone'));">Graveyard:<span id="player_graveyard"></span></div>
                </div>

                <div id="card_details">
                </div>

            </div>

            <div id="table">
                <span class="card_small">
                    <img src="file:///home/marcho/Documents/Projects/ManaClash/images/Island.jpg"/>
                    <span class="header">
                        <span class="title">Foo Bar</span>
                        <span class="manacost">1UU</span>
                    </span>
                         <span class="power">3/2</span>
 
                    <span class="body">
                        <span class="types">Legendary Creature Bar</span>
                        <span class="text">Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque aliquet consequat leo vitae ornare. Proin placerat mauris eu risus dictum imperdiet. Praesent egestas arcu sit amet est sollicitudin ac molestie sapien dapibus. Proin eu eros neque, sed adipiscing leo. Mauris bibendum, sapien sit amet viverra malesuada, ipsum risus hendrerit tellus, sed tristique tellus nunc a nisi. Ut porttitor augue gravida purus convallis eu feugiat elit pulvinar. Nam sit amet cursus tortor. Vestibulum ipsum metus, auctor quis malesuada ut, tempor id lectus. In cursus, lacus id convallis euismod, augue dui porttitor turpis, quis luctus sapien purus sagittis metus. Nulla vitae magna eros. Nam non tortor tortor.

Phasellus ut velit quis tellus ornare pulvinar. Nam adipiscing odio vitae ipsum lacinia vitae accumsan lectus auctor. In consequat pulvinar mi, et rhoncus est accumsan eget. Cras faucibus, eros eu ullamcorper viverra, urna magna molestie lectus, ut molestie est risus id eros. Ut magna ligula, lacinia nec fringilla id, pellentesque ac mauris. Aliquam sit amet lorem massa, ac malesuada est. Donec sagittis semper sollicitudin. Morbi suscipit, nunc eget porta elementum, libero augue ornare metus, in sollicitudin massa lectus in massa. Donec euismod scelerisque quam imperdiet varius. Donec iaculis felis vel magna euismod ac dignissim urna ullamcorper. </span>
                    </span>
                </span>

                <span class="tapped_small">
                    <img src="file:///home/marcho/Documents/Projects/ManaClash/images/Island.jpg"/>
                    <span class="header">
                        <span class="title">Foo Bar</span>
                        <span class="manacost">1UU</span>
                    </span>
                    <span class="power">3/2</span>

                    <span class="body">
                        <span class="types">Legendary Creature Bar</span>
                        <span class="text">Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque aliquet consequat leo vitae ornare. Proin placerat mauris eu risus dictum imperdiet. Praesent egestas arcu sit amet est sollicitudin ac molestie sapien dapibus. Proin eu eros neque, sed adipiscing leo. Mauris bibendum, sapien sit amet viverra malesuada, ipsum risus hendrerit tellus, sed tristique tellus nunc a nisi. Ut porttitor augue gravida purus convallis eu feugiat elit pulvinar. Nam sit amet cursus tortor. Vestibulum ipsum metus, auctor quis malesuada ut, tempor id lectus. In cursus, lacus id convallis euismod, augue dui porttitor turpis, quis luctus sapien purus sagittis metus. Nulla vitae magna eros. Nam non tortor tortor.

Phasellus ut velit quis tellus ornare pulvinar. Nam adipiscing odio vitae ipsum lacinia vitae accumsan lectus auctor. In consequat pulvinar mi, et rhoncus est accumsan eget. Cras faucibus, eros eu ullamcorper viverra, urna magna molestie lectus, ut molestie est risus id eros. Ut magna ligula, lacinia nec fringilla id, pellentesque ac mauris. Aliquam sit amet lorem massa, ac malesuada est. Donec sagittis semper sollicitudin. Morbi suscipit, nunc eget porta elementum, libero augue ornare metus, in sollicitudin massa lectus in massa. Donec euismod scelerisque quam imperdiet varius. Donec iaculis felis vel magna euismod ac dignissim urna ullamcorper. </span>
                    </span>

                </span>

                <span class="card_small">
                    <span class="header">
                        <span class="title">Foo Bar</span>
                        <span class="manacost">1UU</span>
                    </span>
                    <span class="power">3/2</span>
                    <span class="body">
                        <span class="types">Legendary Creature Bar</span>
                        <span class="text">Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque aliquet consequat leo vitae ornare. Proin placerat mauris eu risus dictum imperdiet. Praesent egestas arcu sit amet est sollicitudin ac molestie sapien dapibus. Proin eu eros neque, sed adipiscing leo. Mauris bibendum, sapien sit amet viverra malesuada, ipsum risus hendrerit tellus, sed tristique tellus nunc a nisi. Ut porttitor augue gravida purus convallis eu feugiat elit pulvinar. Nam sit amet cursus tortor. Vestibulum ipsum metus, auctor quis malesuada ut, tempor id lectus. In cursus, lacus id convallis euismod, augue dui porttitor turpis, quis luctus sapien purus sagittis metus. Nulla vitae magna eros. Nam non tortor tortor.

Phasellus ut velit quis tellus ornare pulvinar. Nam adipiscing odio vitae ipsum lacinia vitae accumsan lectus auctor. In consequat pulvinar mi, et rhoncus est accumsan eget. Cras faucibus, eros eu ullamcorper viverra, urna magna molestie lectus, ut molestie est risus id eros. Ut magna ligula, lacinia nec fringilla id, pellentesque ac mauris. Aliquam sit amet lorem massa, ac malesuada est. Donec sagittis semper sollicitudin. Morbi suscipit, nunc eget porta elementum, libero augue ornare metus, in sollicitudin massa lectus in massa. Donec euismod scelerisque quam imperdiet varius. Donec iaculis felis vel magna euismod ac dignissim urna ullamcorper. </span>
                    </span>
                </span>
            </div>

            <div id="game_messages">
                <div id="messages">
                    <div id="message">foo</div>
                    <div id="message">foo</div>
                    <div id="message">foo</div>
                    <div id="message">foo</div>
                    <div id="message">foo</div>
                </div>
                <div id="game_messages_form">
                    <input id="game_messages_input" name="game_messages_input" /> <button id="game_messages_send">Send</button> <button id="game_messages_expand">^</button>
                </div>
            </div>

            <div id="zones">
                <button id="zones_hide" onclick="showZone(null);">X</button>
                <div class="zone" id="player_graveyard_zone"></div>
                <div class="zone" id="player_library_zone"></div>
                <div class="zone" id="opponent_graveyard_zone"></div>
                <div class="zone" id="opponent_library_zone"></div>
            </div>
        </div>

        <div class="view" id="view_cards">
            
            <div>
                <select id="cards_decks" onchange="cardsSelectDeck();"></select>
            </div>
            <div>
                <input id="cards_deckname"/> <button onclick="cardsDeckNew();">New</button> <button onclick="cardsDeckRename();">Rename</button> <button onclick="cardsDeckDelete();">Delete</button>
            </div>

            <select id="cards_available" multiple="multiple" onchange="cardsAvailableChanged();"></select>
            <div id="cards_buttons">
                <button onclick="cardsRemove();">&lt;&lt;</button> <button onclick="cardsAdd();">&gt;&gt;</button>
            </div>
            <select id="cards_deck" multiple="multiple" onchange="cardsDeckChanged();"></select>
            <div id="cards_detail">
            </div>
        </div>

        <div class="view" id="view_settings">
            <h3>Settings</h3>

            <div>
                <div>
                    <div>Card Images URL prefix</div>
                    <div><input id="settings_imgprefix" name="settings_imgprefix"/></div>
                </div>

                <div>
                    <button id="settings_save" name="settings_save" onclick="settingsSave();">Save</button>
                </div>
            </div>
        </div>
    </body>
</html>
