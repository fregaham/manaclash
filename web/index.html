<!DOCTYPE html>
<html>
    <head>
        <script src="autobahn.min.js"></script>
        <script src="jquery-1.7.2.js"></script>
        <script>
        // WAMP session object
        var sess;
        var wsuri;

        window.onload = function() {

            if (window.location.protocol === "file:") {
                wsuri = "ws://localhost:9000";
            } else {
                wsuri = "ws://" + window.location.hostname + ":9000";
            }

            // connect to WAMP server
            ab.connect(wsuri,

               // WAMP session was established
               function (session) {

                  sess = session;
                  console.log("Connected!");

                  sess.subscribe("http://manaclash.org/users", onUsers);
                  sess.subscribe("http://manaclash.org/games", onGames);
               },

               // WAMP session is gone
               function (code, reason) {
                  sess = null;
                  alert(reason);
               }
            );
         };

         function onUsers(topicUri, users) {
            $("#userlist").empty();
            for (var i = 0; i < users.length; i++) {
                $("#userlist").append ("<p>" + users[i] + "</p>");
            }
         }

         function onGames(gamesUri, games) {
            $("#gameslist").empty();

            for (var i = 0; i < games.length; i++) {
                var gameElement = $("<div>" + games[i].id + "</div>").appendTo($("#gameslist"));

                var players = 0;
                for (var j = 0; j < games[i].players.length; j++) {
                    if (games[i].players[j].role == "player1" || games[i].players[j].role == "player2") {
                        ++players;
                    }
                    var playerElement = $("<div>" + games[i].players[j].login + " (" + games[i].players[j].role + ")</div>").appendTo(gameElement);
                }

                if (players < 2) {
                    $("<button>Join</button>").appendTo(gameElement).click({"game_id":games[i].id}, function(event) {
                        sess.call("http://manaclash.org/games/join", event.data.game_id, "player2").then(
                            function(uri) {
                                if(uri != null) {
                                    sess.subscribe(uri, onGame);
                                }
                            }
                        );
                    });
                }
            }
         }

         function login() {
            sess.call("http://manaclash.org/login", $("#username").val(), $("#password").val()).then(
                function(result) {
                     if(!result) {
                        alert("Login failed!");
                     }
                },
                function(){ alert("failed to login!"); }
            );
         }

         function creategame() {
            var uri = sess.call("http://manaclash.org/games/create");
            if (uri != null) {
                sess.subscribe(uri, onGame);
            }
         }

    </script>
    </head>
    <body>
        <h1>ManaClash</h1>

        <h3>Users</h3>
        <div id="userlist"></div>

        <h3>Games</h3>
        <div id="gameslist"></div>

        <div id="login">
            Username: <input id="username" name="username"/>
            Password: <input id="password" name="password" type="password"/>
            <button onclick="login();">Login</button>
        </div>

        <div>
            <button onclick="creategame();">Create Game</button>
        </div>
    </body>
</html>
