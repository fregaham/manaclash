<!DOCTYPE html>
<html>
    <head>
        <script src="autobahn.min.js"></script>
        <script src="jquery-1.7.2.js"></script>
        <script src="functional.js"></script>
        <script>
// <![CDATA[
        // WAMP session object
        var sess;
        var wsuri;

        var g_login = null;
        var g_role = null;
        var g_gameuri = null;
        var g_timer = null;
        var g_timeout = null;
        var g_state = null;
        var g_playermap = null;
        var g_imgprefix = null;

        // After clicking join, switch to game view automatically when the game starts
        var g_waiting_for_game = false;

        // map id -> game object
        var g_objects = {};

        // Is autopass cancelled?
        var g_autopass_cancel = false;

        // map object id -> zone (e.g. "player_hand", "opponent_graveyard", etc.)
        var g_zone_map = {};

        // Currently waiting for a random duel
        var g_waiting_for_duel = false;

        // currently detailed card id
        var g_detail_id = null;

        // List of available cards
        var g_cards_available = [];
        var g_cards_decknames = [];
        var g_cards_decks = {};
        var g_cards_available_map = {};

        window.onload = function() {

            if (window.location.protocol === "file:") {
                wsuri = "ws://localhost:9000";
            } else {
                wsuri = "ws://" + window.location.hostname + ":9000";
            }

            // connect to WAMP server
            ab.connect(wsuri,

               // WAMP session was established
               function (session) {

                  sess = session;
                  console.log("Connected!");

                  sess.subscribe("http://manaclash.org/chat", onChat);
                  sess.subscribe("http://manaclash.org/chat_history", onChatHistory);

                  sess.subscribe("http://manaclash.org/users", onUsers);
                  sess.subscribe("http://manaclash.org/games", onGames);

                  cardsSetup();
               },

               // WAMP session is gone
               function (code, reason) {
                  sess = null;
                  alert(reason);
               }
            );

            $("#autopass").click(function(event) {
                stopTimer();
                g_autopass_cancel = true;
                $("#autopass").hide();
            });
            $("#autopass").hide();

            $("#query_button").click(function(event) {
                onQueryButton();
            });

            $("#game_messages_expand").click(function(event) {
                expandLog();
            });

            $("#game_messages_send").click(function(event) {
                sendMessage();
            });

            view("view_login");
            showZone(null);

            // clear the log
            $("#messages").empty();

            if(typeof(Storage)!=="undefined") {
                g_imgprefix = localStorage.imgprefix;
                $("#settings_imgprefix").val(g_imgprefix);
            }

        };

        function subscribeGame(gameUri) {
            sess.subscribe(gameUri + "/state", onGame);
            sess.subscribe(gameUri + "/zoneTransfer", onLogZoneTransfer);
            sess.subscribe(gameUri + "/action", onLogAction);
            sess.subscribe(gameUri + "/number", onLogNumber);
            sess.subscribe(gameUri + "/message", onLogMessage);
            sess.subscribe(gameUri + "/endgame", onEndGame);
            sess.subscribe(gameUri + "/win", onGameWin);

            sess.subscribe(gameUri + "/player/online", onPlayerOnline);
            sess.subscribe(gameUri + "/player/offline", onPlayerOffline);
        }

        function unsubscribeGame(gameUri) {
            sess.unsubscribe(gameUri + "/state");
            sess.unsubscribe(gameUri + "/zoneTransfer");
            sess.unsubscribe(gameUri + "/action");
            sess.unsubscribe(gameUri + "/number");
            sess.unsubscribe(gameUri + "/message");
            sess.unsubscribe(gameUri + "/endgame");
            sess.unsubscribe(gameUri + "/win");

            sess.unsubscribe(gameUri + "/player/online");
            sess.unsubscribe(gameUri + "/player/offline");

        }

        function lobbyRandomDuel() {
            var deckname = $("#cards_decks").val();
            var deck = g_cards_decks[deckname];


            sess.call("http://manaclash.org/random_duel", deck).then(
                function(ret) {
                    if(ret) {
                        g_waiting_for_duel = true;
                        $("#lobby_random_duel").attr("disabled", "disabled");
                    }
                });
        }

        function lobbyChatSend() {
            sess.publish("http://manaclash.org/chat", $("#lobby_chat_input").val(), false);
        }

        function lobbyChatExpand() {
            $("#lobby_chat").toggleClass("lobby_chat_expanded");
            $("#lobby_chat_messages").scrollTop($("#lobby_chat_messages")[0].scrollHeight);
        }

        function lobbyChatFormat(message) {
            var date = new Date(message[0] * 1000);
            var login = message[1];
            var content = message[2];
            var msg = $("<div class='message'></div>");

            var date_formatted = date.toLocaleDateString() + " " + date.toLocaleTimeString();
            if (date.toLocaleDateString() == (new Date()).toLocaleDateString()) {
                date_formatted = date.toLocaleTimeString();
            }

            msg.append(date_formatted + " ");
            $("<b></b>").text(login + ": ").appendTo(msg);
            $("<span></span>").text(content).appendTo(msg);
            return msg;
        }

        function onChat(topicUri, message) {
            var msg = lobbyChatFormat(message);
            msg.appendTo($("#lobby_chat_messages"));

            $("#lobby_chat_messages").scrollTop($("#lobby_chat_messages")[0].scrollHeight);
        }

        function onChatHistory(topicUri, messages) {
            for (var i = 0; i < messages.length; i++) {
                var msg = lobbyChatFormat(messages[i]);
                msg.appendTo($("#lobby_chat_messages"));
            }

            $("#lobby_chat_messages").scrollTop($("#lobby_chat_messages")[0].scrollHeight);
        }

        function onUsers(topicUri, users) {
            $("#userlist").empty();
            for (var i = 0; i < users.length; i++) {
                $("<div></div>").text(users[i]).appendTo($("#userlist"));
            }
        }

        function onGames(gamesUri, games) {
            $("#gameslist").empty();

            for (var i = 0; i < games.length; i++) {
                var gameElement = $("<div class='lobby_table'></div>").appendTo($("#gameslist"));

                var players = 0;
                var have_me = false;

                for (var j = 0; j < games[i].players.length; j++) {
                    
                    if (games[i].players[j].role == "player1" || games[i].players[j].role == "player2") {
                        ++players;
                    }

                    if (j != 0) {
                        gameElement.append(", ");
                    }
                    var playerElement = $("<span></span>").text(games[i].players[j].login).appendTo(gameElement);

                    if (games[i].players[j].login == g_login) {
                        have_me = true;
                    }

                    if (games[i].players[j].login == g_login && !(g_gameuri == games[i].uri && g_role == games[i].players[j].role)) {

                        if (g_waiting_for_duel) {
                            // Immediately takeover
                            g_waiting_for_duel = false;
                            $("#lobby_random_duel").removeAttr("disabled");;
                            sess.call("http://manaclash.org/takeover", games[i].id, games[i].players[j].role).then(
                                function(ret) {
                                    g_waiting_for_game = true;
                                    var uri = ret[0];
                                    var role = ret[1];
                                    subscribeGame(uri);
                                    g_role = role;
                                    g_gameuri = uri;
                                    sess.call("http://manaclash.org/refresh")
                                }
                            );
                        }
                        else {
                            gameElement.addClass("lobby_table_takeover");
                            gameElement.append(" (click to takeover)");
                            gameElement.click({"game_id":games[i].id, "role":games[i].players[j].role}, function(event) {
                                sess.call("http://manaclash.org/takeover", event.data.game_id, event.data.role).then(
                                    function(ret) {
                                        g_waiting_for_game = true;
                                        var uri = ret[0];
                                        var role = ret[1];
                                        subscribeGame(uri);
                                        g_role = role;
                                        g_gameuri = uri;
                                        sess.call("http://manaclash.org/refresh")
                                    }
                                );
                            });
                        }
                    }
                }

                if (players ==  0) {
                    gameElement.addClass("lobby_table_empty");
                }
            }
        }

        function onPlayerOffline(uri, message) {
            var login = message[0];
            var role = message[1];

            var msg = appendLog("" + login + " goes offline");

            if (role == g_role) {
                msg.addClass("player_message");
            }
            else {
                msg.addClass("opponent_message");
            }
        }

        function onPlayerOnline(uri, message) {
            var login = message[0];
            var role = message[1];

            var msg = appendLog("" + login + " back online");

            if (role == g_role) {
                msg.addClass("player_message");
            }
            else {
                msg.addClass("opponent_message");
            }

        }

        function login() {
            g_login = $("#username").val();
            sess.call("http://manaclash.org/login", $("#username").val(), $("#password").val()).then(
                function(result) {
                     if(!result) {
                        alert("Login failed!");
                        g_login = null;
                     }
                     else {
                        view('view_lobby');
                     }
                },
                function(){ alert("failed to login!"); }
            );
        }

        function onGame(gameUri, state) {
            /* Check the game URI */
            if (gameUri.slice(0, g_gameuri.length) == g_gameuri) {
                var event = gameUri.slice(g_gameuri.length);
                if (event == "/state") {
                    onState(state);
                }
            }
        }

        function endGame() {
            if (window.confirm("Are you sure to end the current game?")) {
                sess.publish(g_gameuri + "/endgame", g_login, false);
            }
        }

        function onEndGame(uri, login) {
            
            var msg = appendLog("Game ended by " + login);

            if (login == g_login) {
                msg.addClass("player_message");
            }
            else {
                msg.addClass("opponent_message");
            }

            unsubscribeGame(g_gameuri);

            g_gameuri = null;
            g_role = null;

        }

        function onGameWin(uri, role) {
            if (role == null) {
                var msg = appendLog("Game ended in a draw!");
                msg.addClass("player_message");
            }
            else {
                var msg = appendLog("" + g_playermap[role].name + " wins the game!");
                if (role == g_role) {
                    msg.addClass("player_message");
                }
                else {
                    msg.addClass("opponent_message");
                }
            }
        }

        /*
            Renders the card elements
            objSpan, the root span of the card
            obj the object representing the card, as got from the server
        */
        function displayCardContents(objSpan, obj, tags) {
            // color
            var color = "colorless";
            var colors = ["red", "blue", "white", "black", "green", "multicolor"];
            for (var i = 0; i < colors.length; i++) {
                if (obj.tags.indexOf(colors[i]) >= 0) {
                    color = colors[i];
                }
            }

            if (color == "colorless" && obj.types.indexOf("land") >= 0) {
                color = "land";
            }

            var land_subtypes = ["forest", "swamp", "island", "plains", "mountain"];
            for (var i = 0; i < land_subtypes.length; i++) {
                if (color == "land" && obj.subtypes.indexOf(land_subtypes[i]) >= 0) {
                    color = land_subtypes[i];
                }
            }

            objSpan.addClass("card_" + color);

            var contentDiv = $("<div class='card_content'></div>");
            contentDiv.appendTo(objSpan);

            var headerSpan = $("<span class='header'/>");
            headerSpan.appendTo(contentDiv);

            var titleSpan = $("<span class='title'></span>");
            titleSpan.text(obj.title);
            titleSpan.appendTo(headerSpan);
           
            var costSpan = $("<span class='manacost'></span>");
            costSpan.text(obj.manacost);
            costSpan.appendTo(headerSpan);

            var bodySpan = $("<span class='body'/>");
            bodySpan.appendTo(contentDiv);

            var typeSpan = $("<span class='types'></span>");
            typeSpan.text(obj.supertypes.join(" ") + " " + obj.types.join(" "));

            if (obj.subtypes.length > 0) {
                typeSpan.append(" &ndash; ");
            }

            typeSpan.append(obj.subtypes.join(" "));
            typeSpan.appendTo(bodySpan);

            var textSpan = $("<span class='text'></span>");
            if (tags) {
                var tagsSpan = $("<span></span>");
                // tagSpan.text(obj.tags.join(" "));
                for (var i = 0; i < obj.tags.length; i++) {
                    var tagSpan = $("<span></span>");
                    tagSpan.text(obj.tags[i]);
                    tagsSpan.append(tagSpan);
                    tagsSpan.append("<br/>");
                }
                var tSpan = $("<span></span>");
                tSpan.text(obj.text);

                if (obj.tags.length > 0) {
                    textSpan.append(tagsSpan);
                    textSpan.append($("<br/>"));
                }
                textSpan.append(tSpan);
            }
            else {
                textSpan.text(obj.text);
            }
            textSpan.appendTo(bodySpan);

            if (obj.power != null) {
                var powerSpan = $("<span class='power'></span>");
                powerSpan.text(obj.power + "/" + obj.toughness);
                powerSpan.appendTo(textSpan);
            }
       }

        /*
            Creates and returns a card <span/> from the server card object
            Also creates a "card_detail" span for this card and appends it hidden into the card_detail container
        */
        function displayCard(obj) {

            // Store all objects in a map
            g_objects[obj.id] = obj;

            var objSpan = $("<span class='" + (obj.tapped ? "card_small card_tapped" : "card_small") + "' id='obj_" + obj.id + "'></span>");
            var detailSpan = $("<span class='card_detail' id='detail_" + obj.id + "'></span>");

            if (obj.show_to.indexOf(g_role) >= 0) {

                var fulltext =  "#" + obj.id + " " + obj.title + " " + obj.manacost + " " + obj.supertypes.join(" ") + " " + obj.types.join(" ");
                if (obj.subtypes.length > 0) {
                    fulltext += " - ";
                }
                fulltext += obj.subtypes.join(" ") + " ";
    
                fulltext += obj.text;

                if (obj.power != null) {
                    fulltext += " " + obj.power + "/" + obj.toughness;
                }

                objSpan.attr("title", fulltext);

                // Try to display as an image, only if we have configured image URLs and the card is not an "effect" nor "damage assignment"
                if (g_imgprefix != null && g_imgprefix != "" && obj.tags.indexOf("effect") < 0 && obj.tags.indexOf("damage assignment") < 0) {
                    var img = $("<img/>");
                    var imgstring = obj.title + ".jpg";
                    img.attr("src", g_imgprefix + imgstring);
                    img.attr("alt", "");

                    img.appendTo(objSpan);
                }
                else {
                    displayCardContents(objSpan, obj, false);
                }

                displayCardContents(detailSpan, obj, true);
            }
            else {
                // backside
                var img = $("<img/>");
                img.attr("src", "mc_back.png");
                img.appendTo(objSpan);
            }

            detailSpan.hide();
            detailSpan.appendTo($("#card_details"));

            // Display card details on the currently hovered card, also, highlight any card targets, blockers and attackers
            objSpan.hover(
                function(id) {
                    // hide the old detail and unhighlight targets
                    if (g_detail_id != null) {
                        $("#detail_" + g_detail_id).hide();

                        var obj = g_objects[g_detail_id];
                        for (var i = 0; i < obj.targets.length; ++i) {
                            $("#obj_" + obj.targets[i]).removeClass("targeted");
                        }
                        for (var i = 0; i < obj.blockers.length; ++i) {
                            $("#obj_" + obj.blockers[i]).removeClass("targeted");
                        }
                        for (var i = 0; i < obj.attackers.length; ++i) {
                            $("#obj_" + obj.attackers[i]).removeClass("targeted");
                        }
                    }
                    $("#detail_" + id).show();
                    g_detail_id = id;

                    var obj = g_objects[id];
                    for (var i = 0; i < obj.targets.length; ++i) {
                        $("#obj_" + obj.targets[i]).addClass("targeted");
                    }
                    for (var i = 0; i < obj.blockers.length; ++i) {
                        $("#obj_" + obj.blockers[i]).addClass("targeted");
                    }
                    for (var i = 0; i < obj.attackers.length; ++i) {
                        $("#obj_" + obj.attackers[i]).addClass("targeted");
                    }

                }.partial(obj.id),
                function(id) {
                    $("#detail_" + id).hide();

                    var obj = g_objects[id];
                    for (var i = 0; i < obj.targets.length; ++i) {
                        $("#obj_" + obj.targets[i]).removeClass("targeted");
                    }
                    for (var i = 0; i < obj.blockers.length; ++i) {
                        $("#obj_" + obj.blockers[i]).removeClass("targeted");
                    }
                    for (var i = 0; i < obj.attackers.length; ++i) {
                        $("#obj_" + obj.attackers[i]).removeClass("targeted");
                    }

                    g_detail_id = null;
                }.partial(obj.id)
            );

            return objSpan;
        }

        function displayZone(zone_name, state_zone, div) {
            for (var i = 0; i < state_zone.length; ++i) {
                var obj = state_zone[i];

                var objSpan = displayCard(obj);
                objSpan.appendTo(div);

                g_zone_map[obj.id] = zone_name;
            }
        }

        function selectAction(i) {
            stopTimer();
            sess.publish(g_gameuri, i);

            g_autopass_cancel = false;

            $("#pass").attr("disabled", "disabled");

            /* clear the "action_zone_button" classes from any zone_buttons */
            $(".action_zone_button").removeClass("action_zone_button");
            $(".action_zone").removeClass("action_zone");

        }

        function onState(state) {
            if (g_waiting_for_game) {
                g_waiting_for_game = false;
                view("view_game");
            }

            g_state = state;
            g_zone_map = {};

            var table = $("#table");
            table.empty();

            $('#text').empty();

            $("#phase").empty();
            $("#phase").text(state["phase"]);

            $("#step").empty();
            $("#step").text(state["step"]);

            $("#card_details").empty();

            var in_play = [];
            var in_play_battle = [];
            var player_hand = [];
            var players = [];
            // playerN -> player|opponent
            var rolemap = {};
            
            // playerN -> player object
            g_playermap = {};

            if (g_role == "player1") {
                players.push("player");
                players.push("opponent");
            }
            else {
                players.push("opponent");
                players.push("player");
            }

            player_divs = [];
           
            for (var i = 0; i < players.length; ++i) {
                player_divs[players[i]] = $("<div></div>");
                rolemap["player" + (i+1)] = players[i];
            }

            var stack = $("<div id='zone_stack'></div>");
            displayZone("stack", state["stack"], stack);

            player_divs["opponent"].appendTo(table);
            stack.appendTo(table);
            player_divs["player"].appendTo(table);

            in_play["opponent"] = $("<div></div>").appendTo(player_divs["opponent"]);
            in_play_battle["opponent"] = $("<div></div>").appendTo(player_divs["opponent"]);

            in_play_battle["player"] = $("<div></div>").appendTo(player_divs["player"]);
            in_play["player"] = $("<div></div>").appendTo(player_divs["player"]);

            player_hand = $("<div></div>").appendTo(player_divs["player"]);

            for (var i = 0; i < state["in_play"].length; ++i) {
                var obj = state["in_play"][i];

                if (obj.controller != null) {
                    objSpan = displayCard(obj);

                    var zone = null;
                    var zone_name = null;
                    if (obj.tags.indexOf("attacking") >= 0 || obj.tags.indexOf("blocking") >= 0) {
                        zone_name = rolemap[obj.controller] + "_in_play_battle";
                        zone = in_play_battle[rolemap[obj.controller]];
                    }
                    else {
                        zone_name = rolemap[obj.controller] + "_in_play";
                        zone = in_play[rolemap[obj.controller]];
                    }

                    objSpan.appendTo(zone);

                    if (obj.tapped) {
                        $("<span class='tapped_dummy'></span>").appendTo(zone);
                    }

                    g_zone_map[obj.id] = zone_name;
                }
            }

            for (var i = 0; i < state["players"].length; ++i) {
                var player = state["players"][i];

                g_playermap["player" + (i+1)] = player;

                $("#" + rolemap[player.role] + "_name").empty(); 
                $("#" + rolemap[player.role] + "_name").text(player.name);

                if (player.library.length == 0) {
                    $("#" + rolemap[player.role] + "_library").empty();
                    $("#" + rolemap[player.role] + "_library").addClass("empty_stack");
                }
                else {
                    if ($("#" + rolemap[player.role] + "_library").children().length == 0) {
                        $("#" + rolemap[player.role] + "_library").removeClass("empty_stack");
                        var img = $("<img src='./mc_back.png'/>");
                        img.css("width", 40);
                        img.css("height", 58);
                        img.appendTo($("#" + rolemap[player.role] + "_library"));
                    }
                }

                $("#" + rolemap[player.role] + "_library").attr("title", "Library: " + player.library.length);

                if (player.graveyard.length == 0) {
                    $("#" + rolemap[player.role] + "_graveyard").empty();
                    $("#" + rolemap[player.role] + "_graveyard").addClass("empty_stack");
                }
                else {
                    $("#" + rolemap[player.role] + "_graveyard").removeClass("empty_stack");

                    var topcard = $("<span class='card_small card_graveyard'></span>");
                    displayCardContents(topcard, player.graveyard[player.graveyard.length - 1], false);
                    topcard.appendTo($("#" + rolemap[player.role] + "_graveyard"));
                }

                $("#" + rolemap[player.role] + "_graveyard").attr("title", "Graveyard: " + player.graveyard.length);

                $("#" + rolemap[player.role] + "_life").empty(); 
                $("#" + rolemap[player.role] + "_life").text(player.life);

                $("#" + rolemap[player.role] + "_manapool").empty(); 
                $("#" + rolemap[player.role] + "_manapool").text(player.manapool);

                $("#" + rolemap[player.role] + "_graveyard_zone").empty(); 
                $("#" + rolemap[player.role] + "_library_zone").empty(); 

                displayZone(rolemap[player.role] + "_graveyard", player["graveyard"], $("#" + rolemap[player.role] + "_graveyard_zone"));
                displayZone(rolemap[player.role] + "_library", player["library"], $("#" + rolemap[player.role] + "_library_zone"));

                if (rolemap[player.role] == "player") {
                    displayZone("player_hand", player["hand"], player_hand);

                    $("#player_hand").empty(); 
                    $("#player_hand").text(player.hand.length);

                }
                else {
                    $("#" + rolemap[player.role] + "_hand_zone").empty();
                    displayZone(rolemap[player.role] + "_hand", player["hand"], $("#" + rolemap[player.role] + "_hand_zone"));

                    if ($("#" + rolemap[player.role] + "_hand").children().length != player.hand.length) {

                        $("#" + rolemap[player.role] + "_hand").empty();
                        $("#" + rolemap[player.role] + "_hand").attr("title", "Hand: " + player.hand.length);

                        for (var j = 0; j < player.hand.length; j++) {
                            var img = $("<img src='./mc_back.png'/>");
                            
                            img.css("position", "absolute");
                            img.css("width", 40);
                            img.css("height", 58);

                            img.css("left", ((180 - 40) / (player.hand.length - 1)) * j);
    
                            img.appendTo($("#" + rolemap[player.role] + "_hand"));
                        }
                    }
                }
            }

            $("#turn").empty();
            $("#turn").text(g_playermap[state["turn"]].name);

            var actions_div = $("#actions");
            actions_div.empty();

            var query = $("#query");
            query.hide();

            var pass = $("#pass");
            pass.attr("disabled", "disabled");

            if (state["text"] != "You have priority" && state["player"] != null) {
                appendLog("" + g_playermap[state["player"]].name + ", " + state["text"]);
            }

            /* It is our "turn" now */
            if (g_role == state["player"]) {

                $("#text").text(state["text"]);

                if (state["actions"] != null) {

                    var autopass = true;
                    var haspass = false;

                    if (state["text"] != "You have priority") {
                        autopass = false;
                    }

                    for (var i = 0; i < state["actions"].length; ++i) {
                        var action = state["actions"][i];

                        if (action["object"] == null) {
                            /* action with now object, display it as a button in the actions list */

                            if (action["text"] != "Pass") {
                                autopass = false;
                                var action_span = $("<button></button>").appendTo(actions_div);
                                action_span.text(action["text"]);
                                action_span.addClass('action_button');
                                action_span.click({'i':i}, function(event) {
                                    selectAction(event.data.i);
                                });
                            }
                            else {
                                haspass = true;
                                pass.removeAttr("disabled");
                            }
                        }
                        else {
                            /* action with an object, let the user click on the object */

                            if (action["manaability"] == null || action["manaability"] == false) {
                                autopass = false;
                            }

                            var action_obj = $('#obj_' + action["object"]);
                            action_obj.addClass('action');
                            action_obj.click({'i':i}, function(event) {
                                selectAction(event.data.i);
                            });

                            /* Highlight the zone button if the object is in a zone that is not visible by default  */
                            if (g_zone_map[action["object"]] !== undefined) {
                                var zone = $("#" + g_zone_map[action["object"]]);
                                if (zone !== undefined) {
                                    zone.addClass("action_zone");
                                }
                            }
                        }
                    }

                    // auto select no more attackers if none available
                    if (state["actions"].length == 1 && state["actions"][0]["text"] == "No more attackers" && state["step"] == "declare attackers" && state["text"] == "Select attackers") {
                        autopass = true;
                    }

                    // auto select no more blockers if none available
                    if (state["actions"].length == 1 && state["actions"][0]["text"] == "No more blockers" && state["step"] == "declare blockers" && state["text"] == "Select blockers") {
                        autopass = true;
                    }

                    if (autopass) {
                        sess.publish(g_gameuri, 0);
                    }
                    else {
                        if (!g_autopass_cancel && state["text"] == "You have priority" && haspass && !(state["turn"] == g_role && (state["phase"] == "precombat main" || state["phase"] == "postcombat main"))) {
                            g_timeout = 3;
                            g_timer = setTimeout('onTimer()', 1000);

                            $("#autopass").empty();
                            $("<div class='autopass_priority'></div>").text(g_state["text"]).append("<br/>" + g_timeout).appendTo($("#autopass"));
                            $("#autopass").show();
                        }
                        else {
                            $("#autopass").hide();
                        }
                    }
                }
                else if (state["query"] != null) {
                    $("#query_text").empty();
                    $("#query_text").text(state["query"]);
                    $("#query_input").val("");
                    query.show();
                }
            } 
            else {
                if (state["player"] != null) {
                    $("#text").append("Waiting for " + g_playermap[state["player"]].name);

                    // It is not our turn
                    $("#autopass").empty();
                    $("<div class='autopass_wait'></div>").text("Waiting for " + g_playermap[state["player"]].name).appendTo($("#autopass"));
                    $("#autopass").show();
                }
                else {
                    // game ended, do nothing
                    $("#autopass").hide();
                }
            }
        }

        function onPass() {
            selectAction(0);
        }

        function onQueryButton() {
            selectAction($("#query_input").val());
        }

        function stopTimer() {
            if (g_timer != null) {
                clearTimeout(g_timer);
            }
            g_timer = null;
            g_timeout = null;
        }

        function onTimer() {

            if (g_timeout == null) {
                return;
            }

            g_timeout--;

            if (g_timeout <= 0) {
                stopTimer();
                $("#pass").attr("disabled", "disabled");
                sess.publish(g_gameuri, 0);
                $("#autopass").empty();
            }
            else {
                $("#autopass").empty();
                $("<div class='autopass_priority'></div>").text(g_state["text"]).append("<br/>" + g_timeout).appendTo($("#autopass"));
                setTimeout('onTimer()', 1000);
            }
        }

        function view(v) {

            var views = ["login", "lobby", "game", "cards", "settings"];

            for (var i = 0; i < views.length; i++) {
                $("#view_" + views[i]).hide();

                if (views[i] != "login") {
                    $("#view_" + views[i] + "_button").removeClass("current_view");
                }
            }

            $("#" + v).show();

            if (v == "view_login") {
                $("#view_menu").hide();
            }
            else {
                $("#view_menu").show();
                $("#" + v + "_button").addClass("current_view");
            }
        }

        function showZone(zone) {
            $("#player_graveyard_zone").hide();
            $("#player_library_zone").hide();
            $("#opponent_graveyard_zone").hide();
            $("#opponent_library_zone").hide();
            $("#opponent_hand_zone").hide();

            if (zone != null) {
                zone.show();
                $("#zones").show();
            }
            else {
                $("#zones").hide();
            }
        }

        // Logs

        function appendLog(log) {
            var msg = $("<div class='message'></div>");
            msg.text(log);
            msg.appendTo($("#messages"));

            $("#messages").scrollTop($("#messages")[0].scrollHeight);

            return msg;
        }

        function onLogZoneTransfer(uri, zoneTransfer) {
            if (zoneTransfer[3] != null) {
                appendLog("card moved from " + zoneTransfer[0] + " to " + zoneTransfer[1]);
            }
            else {
                appendLog("" + zoneTransfer[2].title + " moved from " + zoneTransfer[0] + " to " + zoneTransfer[1]);
            }
        }

        function onLogAction(uri, actionMessage) {
            if (actionMessage[1]["text"] != "Pass") {
                appendLog("" + g_playermap[actionMessage[0]].name + " " + actionMessage[1]["text"]);
            }
        }

        function onLogNumber(uri, numberMessage) {
            appendLog("" + g_playermap[actionMessage[0]].name + " " + actionMessage[1]);
        }

        /* Messages sent by players */
        function onLogMessage(uri, message) {
            var msg = appendLog("" + g_playermap[message[0]].name + " " + message[1]);
            if (message[0] == g_role) {
                msg.addClass("player_message");
            }
            else {
                msg.addClass("opponent_message");
            }
        }

        function sendMessage() {
            sess.publish(g_gameuri + "/message", [g_role, $("#game_messages_input").val()], false);
        }

        function expandLog() {
            $("#game_messages").toggleClass("game_messages_expanded");
            $("#messages").scrollTop($("#messages")[0].scrollHeight);
        }

        function settingsSave() {
            g_imgprefix = $("#settings_imgprefix").val();

            if(typeof(Storage)!=="undefined") {
                localStorage.imgprefix = g_imgprefix;
            }
        }

        /* Stores the current decks into local storage */
        function cardsSave() {
            if(typeof(Storage)!=="undefined") {

                localStorage.cardsDeckname = $("#cards_decks").val();
                var decks = "";
                for (var i = 0; i < g_cards_decknames.length; i++) {
                    decks += "n" + g_cards_decknames[i] + "\n";
                    for (var j = 0; j < g_cards_decks[g_cards_decknames[i]].length; j++) {
                        decks += "c" + g_cards_decks[g_cards_decknames[i]][j][0] + " " + g_cards_decks[g_cards_decknames[i]][j][1] + "\n";
                    }
                }

                localStorage.cardsDecks = decks;
            }
        }

        /* Reads available cards from the server and loads decks from the local storage */
        function cardsSetup() {
            sess.call("http://manaclash.org/getAvailableCards").then(
                function(result) {
                    g_cards_available = result;

                    $("#cards_available").empty();

                    for (var i = 0; i < g_cards_available.length; i++) {
                        var card = g_cards_available[i];
                        $("<option value=\"" + card.title + "\">" + card.title +  "</option>").appendTo($("#cards_available"));

                        g_cards_available_map[card.title] = card;
                    }

                    if(typeof(Storage)!=="undefined") {
                        var decks = localStorage.cardsDecks;
                        if (decks != null) {
                            decks = decks.split("\n");
                            var deck = [];
                            var deckname = null;
                            for (var i = 0; i < decks.length; i++) {
                                if (decks[i] != "") {
                                    if (decks[i][0] == "n") {
                                        if (deck.length > 0) {
                                            g_cards_decknames.push(deckname);
                                            g_cards_decks[deckname] = deck;
                                            deck = [];
                                            deckname = null;
                                        }
                                        deckname = decks[i].substr(1);
                                    }
                                    else if (decks[i][0] == "c") {
                                        var s = decks[i].substr(1);
                                        var num = s.split(" ", 1);
                                        var name = $.trim(s.substr(num.length + 1));
                                        deck.push([parseInt(num), name]);
                                    }
                                }
                            }

                            if (deck.length > 0) {
                                g_cards_decknames.push(deckname);
                                g_cards_decks[deckname] = deck;
                            }
                        }

                        $("#cards_decks").empty();
                        for (var i = 0; i < g_cards_decknames.length; i++) {
                            $("<option>" + g_cards_decknames[i] + "</option>").appendTo($("#cards_decks"));
                        }
                        $("#cards_decks").val(localStorage.cardsDeckname);

                        cardsSelectDeck();
                    }
                },
                function(){ alert("failed to fetch available cards!"); }
            );
        }

        function cardsDeckNew() {
            var deckname = $("#cards_deckname").val();
            g_cards_decknames.push(deckname);
            g_cards_decks[deckname] = [];

            $("#cards_decks").empty();
            for (var i = 0; i < g_cards_decknames.length; i++) {
                $("<option>" + g_cards_decknames[i] + "</option>").appendTo($("#cards_decks"));
            }

            $("#cards_decks").val(deckname);

            $("#cards_deck").empty();

            cardsSave();
        }

        function cardsDeckRename() {
            var deckname = $("#cards_decks").val();
            var newdeckname = $("#cards_deckname").val();
            var deck = g_cards_decks[deckname];
            var i = g_cards_decknames.indexOf(deckname);
            g_cards_decknames.splice(i, 1, newdeckname);
            g_cards_decks[newdeckname] = deck;
            g_cards_decks[deckname] = null;

            $("#cards_decks").empty();
            for (var i = 0; i < g_cards_decknames.length; i++) {
                $("<option>" + g_cards_decknames[i] + "</option>").appendTo($("#cards_decks"));
            }

            $("#cards_decks").val(newdeckname);

            cardsSave();
        }

        function cardsDeckDelete() {

            var deckname = $("#cards_decks").val();
            
            var i = g_cards_decknames.indexOf(deckname);
            g_cards_decknames.splice(i, 1);
            g_cards_decks[deckname] = null;

            $("#cards_decks").empty();
            for (var i = 0; i < g_cards_decknames.length; i++) {
                $("<option>" + g_cards_decknames[i] + "</option>").appendTo($("#cards_decks"));
            }

            $("#cards_deck").empty();

            cardsSave();

            if (g_cards_decknames.length > 0) {
                $("#cards_deck").val(g_cards_decknames[0]);
                cardsSelectDeck();
            }
        }

        /** Adds selected cards form the "available" list to the current deck */
        function cardsAdd() {
            var deckname = $("#cards_decks").val();
            var deck = g_cards_decks[deckname];

            var selected = $("#cards_available").val();
            if (selected != null) {
                for (var i = 0; i < selected.length; i++) {
                    var found = false;
                    for (var j = 0; j < deck.length; ++j) {
                        var n = deck[j][0];
                        var name = deck[j][1];
                        if (name == selected[i]) {
                            deck[j][0] = n + 1;
                            var option = $("#cards_deck>option[value=\""+ name +"\"]");
                            option.empty();
                            option.append(deck[j][0] + " " + deck[j][1]);
                            found = true;
                        }
                    }

                    if (!found) {
                        /* No such card in the deck yet */
                        deck.push([1, selected[i]]);
                        deck.sort(function (a,b) { return a[1].localeCompare(b[1]);} );

                        $("#cards_deck").empty();
                        for (var j = 0; j < deck.length; j++) {
                            var option = $("<option value=\"" + deck[j][1] + "\"></option>").appendTo($("#cards_deck"));
                            option.append("" + deck[j][0] + " " + deck[j][1]);
                        }
                    }
                }

                cardsSave();
            }
        }

        /** Removes selected cards from the current deck */
        function cardsRemove() {
            var deckname = $("#cards_decks").val();
            var deck = g_cards_decks[deckname];

            var selected = $("#cards_deck").val();
            if (selected != null) {
                for (var i = 0; i < selected.length; i++) {
                    for (var j = 0; j < deck.length; j++) {
                        if (deck[j][1] == selected[i]) {
                            deck[j][0] = deck[j][0] - 1;

                            var option = $("#cards_deck>option[value=\""+ selected[i] +"\"]");

                            if (deck[j][0] <= 0) {
                                /* We have removed all cards of this type, remove the whole entry */
                                deck.splice(j, 1);
                                option.remove();
                                break;
                            }
                            else {
                                option.empty();
                                option.append(deck[j][0] + " " + deck[j][1]);
                            }
                        }
                    }
                }

                cardsSave();
            }
        }

        function cardsSelectDeck() {
            var deckname = $("#cards_decks").val();
            var deck = g_cards_decks[deckname];

            $("#cards_deck").empty();

            for (var i = 0; i < deck.length; i++) {
                var option = $("<option value=\"" + deck[i][1] + "\"></option>").appendTo($("#cards_deck"));
                option.append("" + deck[i][0] + " " + deck[i][1]);
            }

            $("#cards_deckname").val(deckname);

            cardsSave();
        }

        function cardsAvailableChanged() {
            $("#cards_detail").empty();
            var selected = $("#cards_available").val();
            
            if (selected != null) {
                for (var i = 0; i < selected.length; i++) {
                    var card = g_cards_available_map[selected[i]];

                    var span = $("<span class='card_small'></span>");
                    displayCardContents(span, card, false);
                    span.appendTo($("#cards_detail"));
                }
            }
        }

        function cardsDeckChanged() {
            $("#cards_detail").empty();
            var selected = $("#cards_deck").val();
            
            if (selected != null) {
                for (var i = 0; i < selected.length; i++) {
                    var card = g_cards_available_map[selected[i]];

                    var span = $("<span class='card_small'></span>");
                    displayCardContents(span, card, false);
                    span.appendTo($("#cards_detail"));
                }
            }

        }

// ]]>
    </script>
    <style>

.login {
    font-size: 15pt;
    text-align: center;
}

.login input {
    font-size: 15pt;
}

.login button {
    font-size: 15pt;
}

.card_small {
    position: relative;
    display: inline-block;
    width: 100px;
    height: 142px;
    cursor: pointer;
    vertical-align: top;
    overflow: hidden;
    border-radius: 6px;
    background: white;
    margin:3px;
}

.card_small > img {
   position: absolute;
   width: 100px;
   height: 142px;
   z-index: 2;
   border-radius: 6px;
}

.card_small > .card_content {
    position: relative;
    left:3px;
    width:90px;
    top:3px;
    height:132px;
    background: gray;
    border: 1px solid black;
    padding: 1px;
}

.tapped_dummy {
    position:relative;
    width:42px;
    height:142px;
    display:inline-block;
}

.card_tapped {
   -webkit-transform: rotate(90deg) translate(-21px, -21px);
   -moz-transform: rotate(90deg) translate(-21px, -21px);
}

.types {
    display: block;
}

.tags {
    display: block;
}

.text {
    display: block;
}

.card_small .header {
    position: absolute;
    font-size: 8px;
    height: 10px;
    width: 88px;
    border: 1px solid black;
}

.card_red > .card_content {
    border: 1px solid #843c2e !important;
    background: #a7524d !important;
}

.card_red .header {
    border: 1px solid #843c2e !important;
    background: #f8ceb6;
}

.card_red .text {
    border: 1px solid #843c2e !important;
    background: #f8ceb6;
}

.card_red .power {
    background: #f8ceb6 !important;
}

.card_green > .card_content {
    border: 1px solid #274939 !important;
    background: #45715a !important;
}

.card_green .header {
    border: 1px solid #274939 !important;
    background: #c8d5cc;
}

.card_green .text {
    border: 1px solid #274939 !important;
    background: #c8d5cc;
}

.card_green .power {
    background: #c8d5cc !important;
}

.card_blue > .card_content {
    border: 1px solid #002c43 !important;
    background: #2f84bd !important;
}

.card_blue .header {
    border: 1px solid #002c43 !important;
    background: #c9dceb;
}

.card_blue .text {
    border: 1px solid #002c43 !important;
    background: #c9dceb;
}

.card_blue .power {
    background: #c9dceb !important;
}

.card_black > .card_content {
    border: 1px solid #312f32 !important;
    background: #4e4548 !important;
}

.card_black .header {
    border: 1px solid #312f32 !important;
    background: #bbb1b0;
}

.card_black .text {
    border: 1px solid #312f32 !important;
    background: #bbb1b0;
}

.card_black .power {
    background: #bbb1b0 !important;
}

.card_white > .card_content {
    border: 1px solid #3f3734 !important;
    background: #fafafa !important;
}

.card_white .header {
    border: 1px solid #3f3734 !important;
    background: #f6f5f3;
}

.card_white .text {
    border: 1px solid #3f3734 !important;
    background: #f6f5f3;
}

.card_white .power {
    background: #f6f5f3 !important;
}

.card_colorless > .card_content {
    border: 1px solid #919199 !important;
    background: #e3e4e8 !important;
}

.card_colorless .header {
    border: 1px solid #919199 !important;
    background: #e3e4e8;
}

.card_colorless .text {
    border: 1px solid #919199 !important;
    background: #e3e4e8;
}

.card_colorless .power {
    background: #e3e4e8 !important;
}

.card_land > .card_content {
    border: 1px solid #564f47 !important;
    background: #bca9a2 !important;
}

.card_land .header {
    border: 1px solid #564f47 !important;
    background: #d7d0ca;
}

.card_land .text {
    border: 1px solid #564f47 !important;
    background: #d7d0ca;
}

.card_land .power {
    background: #d7d0ca !important;
}

.card_forest > .card_content {
    border: 1px solid #274939 !important;
    background: #bca9a2 !important;
}

.card_forest .header {
    border: 1px solid #274939 !important;
    background: #c8d5cc;
}

.card_forest .text {
    border: 1px solid #274939 !important;
    background: #c8d5cc;
}

.card_forest .power {
    background: #c8d5cc !important;
}

.card_mountain > .card_content {
    border: 1px solid #843c2e !important;
    background: #bca9a2 !important;
}

.card_mountain .header {
    border: 1px solid #843c2e !important;
    background: #f8ceb6;
}

.card_mountain .text {
    border: 1px solid #843c2e !important;
    background: #f8ceb6;
}

.card_mountain .power {
    background: #f8ceb6 !important;
}

.card_island > .card_content {
    border: 1px solid #002c43 !important;
    background: #bca9a2 !important;
}

.card_island .header {
    border: 1px solid #002c43 !important;
    background: #c9dceb;
}

.card_island .text {
    border: 1px solid #002c43 !important;
    background: #c9dceb;
}

.card_island .power {
    background: #c9dceb !important;
}

.card_swamp > .card_content {
    border: 1px solid #312f32 !important;
    background: #bca9a2 !important;
}

.card_swamp .header {
    border: 1px solid #312f32 !important;
    background: #bbb1b0;
}

.card_swamp .text {
    border: 1px solid #312f32 !important;
    background: #bbb1b0;
}

.card_swamp .power {
    background: #bbb1b0 !important;
}

.card_plains > .card_content {
    border: 1px solid #3f3734 !important;
    background: #bca9a2 !important;
}

.card_plains .header {
    border: 1px solid #3f3734 !important;
    background: #f6f5f3;
}

.card_plains .text {
    border: 1px solid #3f3734 !important;
    background: #f6f5f3;
}

.card_plains .power {
    background: #f6f5f3 !important;
}

.card_small .header > .title {
    position: absolute;
    text-align: left;
    top: 0px;
    left: 0px;
    height: 10px;
    overflow: hidden;
}

.card_small .header > .manacost {
    position: absolute;
    text-align: right;
    top: 0px;
    right: 0px;
}

.card_small .body {
    display: block;
    position: absolute;
    top: 10px;
    left: 0px;
    width: 92px;
    height: 123px;
    font-size: 8px;
    overflow: hidden;
}

.card_small .body .text {
    border: 1px solid black;
    margin: 1px;
    height: 110px;
}

.card_small .body .types {
    width:88px;
    height:9px;
    margin-top:1px;
    overflow:hidden;
}

.card_small .power {
    display: block;
    position: absolute;
    font-size: 10px;
    height: 10px;
    width: 20px;
    left: 67px;
    bottom: 2px;
    background: inherit;
    z-index: 1;
    text-align: right;
}

.action {
   border: solid 1px yellow;

   box-shadow: 0 0 5px rgba(255, 255, 0, 1);
   -webkit-box-shadow: 0 0 5px rgba(255, 255, 0, 1); 
   -moz-box-shadow: 0 0 5px rgba(255, 255, 0, 1); 
}

.targeted {
    border: solid 1px red !important;

    box-shadow: 0 0 5px rgba(255, 0, 0, 1);
    -webkit-box-shadow: 0 0 5px rgba(255, 0, 0, 1); 
    -moz-box-shadow: 0 0 5px rgba(255, 0, 0, 1); 
}

.action_button {
   display:block;
   width: 200px;
}

.zone_button {
    border: 1px solid #006;
    display:block;
    width: 200px; 
}

.action_zone_button {
    border: 1px solid yellow;
}

#table {
  position:absolute;
  left: 208px;
  top: 0px;
  bottom:100px;
  right:0px;
  background: #336633;
  overflow: auto;
}

#game_messages {
    position: absolute;
    bottom:0px;
    left: 208px;
    right:0px;
    height:100px;
    background: #ffbd6d;
    z-index:10;
    border: 1px solid black;
}

.game_messages_expanded {
    position: absolute;
    bottom:0px;
    left: 208px;
    right:0px;
    top: 0px;
    height: auto !important;
    background: #ffbd6d;
    opacity: 0.9;
    border: 1px solid black;
}

#game_messages_form {
    position:absolute;
    bottom:0px;
    height: 32px;
    left:0px;
    right:0px;
}

#game_messages > #messages {
  position:absolute;
  overflow: auto;
  bottom: 32px;
  top:0px;
  right:0px;
  left:0px;
}

.player_message {
  color: green;
}

.opponent_message {
  color: red;
}

#status {
  position:absolute;
  left:4px;
  top:4px;
  width: 200px;
}

#opponent_life {
    float: right;
    text-align: right;
}

#opponent_hand {
    position: relative;
    width: 180px;
    height: 58px;
    display: block;
    margin-bottom: 10px;
    border: 1px solid black;
    left: 10px;
}

.library_graveyard {
    position: relative;
    width: 180px;
    height: 58px;
    margin-bottom: 10px;
    left: 10px; 
}

.library {
    position: absolute;
    width: 40px;
    height: 58px;
    left: 45px;
    display: inline-block;
    border: 1px solid black;
}

.graveyard {
    position: absolute;
    width: 40px;
    height: 58px;
    display: inline-block;
    border: 1px solid black;
    left: 95px;
}

.card_graveyard {
   position: absolute !important;
   -webkit-transform: translate(-33px, -45px) scale(0.4);
   -moz-transform: translate(-33px, -45px) scale(0.4);
}

#player_life {
    float: right;
    text-align: right;
}

.action_zone{
   border: solid 1px yellow !important;

   box-shadow: 0 0 5px rgba(255, 255, 0, 1);
   -webkit-box-shadow: 0 0 5px rgba(255, 255, 0, 1); 
   -moz-box-shadow: 0 0 5px rgba(255, 255, 0, 1);
}

#timer {
 width: 200px;
}

#pass {
 width: 200px;
}

#zones {
    position:absolute;
    left:300px;
    top:100px;
    right:100px;
    bottom:100px;
    z-index: 5;
    background: #aaccaa;
    border: 1px solid black;
    overflow: auto;
}

#zone_stack {
    background: #428042;
    margin: 8px;
}

#card_details {
    margin-top: 1em;
}

.card_detail {
    position: relative;
    width: 180px;
}

.card_detail .power {
    display: block;
    width: 178px;
    text-align: right;
}

.card_detail .title {
    display: block;
}

.card_detail .header > .title {
    position: absolute;
    text-align: left;
    top: 0px;
    left: 0px;
    overflow: hidden;
}

.card_detail .header > .manacost {
    position: absolute;
    text-align: right;
    top: 0px;
    right: 0px;
}

.card_detail > .card_content {
    position: relative;
    left:3px;
    width:180px;
    top:3px;
    background: gray;
    border: 1px solid black;
    padding: 1px;
}

.card_detail .header {
    border: 1px solid black;
    display: block;
    position: relative;
    height: 17px;
    width: 177px;
}


.view {
    position: absolute;
    left:0px;
    right:0px;
    top:24px;
    bottom:0px;
}

.view_margin {
    position: absolute;
    left:8px;
    right:8px;
    top:8px;
    bottom:8px;
}

#cards_available {
    position:absolute;
    left:0px;
    top:100px;
    width:200px;
    bottom:0px;
}

#cards_buttons {
    position: absolute;
    text-align: center;
    left:200px;
    top:100px;
    width:100px;
}

#cards_deck {
    position:absolute;
    left:300px;
    top:100px;
    width:200px;
    bottom:0px;
}

#cards_detail {
    position:absolute;
    left:550px;
    top:100px;
}

body {
  width: 100%;
  height: 100%;
  padding: 0px;
  margin: 0px;
  background: #f0f0f0;
}

#autopass {
    display: table;
    left:0px;
    top:0px;
    width: 100%;
    height: 100%;
    z-index: 128;
    position: fixed;
    background: black;
    opacity: 0.5;
    text-align: center;
    font-size: 48pt;
    color: light-gray;
}

#autopass > div {
    display: table-cell;
    vertical-align: middle;
}

.autopass_priority {
    color: white;
}

#lobby_chat {
    position: absolute;
    bottom:0px;
    left: 208px;
    right:5px;
    top:100px;
    z-index:10;
    background: #ffbd6d;
    border: 1px solid black;
}

#lobby_chat_form {
    position:absolute;
    bottom:0px;
    height: 32px;
}

#lobby_chat_messages {
  position:absolute;
  overflow: auto;
  bottom: 32px;
  top:0px;
  right:0px;
  left:0px;
}

.lobby_table {
    display: block;
    width: 180px;
    margin-top:8px;
    border: 1px solid black;
    background: #669966;
    cursor: default;
}

.lobby_table_empty {
    background: gray !important;
}

.lobby_table_takeover {
    background: yellow !important;
}

#view_menu {
    position: absolute;
    left:0px;
    top:0px;
    right:0px;
    height:24px;
    background: white;
    border-bottom: 1px solid black;
}

#view_menu a {
    background: white;
    border-bottom: 1px solid black;
    display: inline-block;
    height: 15px;
    padding: 4px;
    cursor: default;
}

#view_menu .current_view {
    background: #f0f0f0 !important;
    border-bottom: 1px solid #f0f0f0;
    border-left: 1px solid black;
    border-right: 1px solid black;
    border-top: 1px solid black;
}

    </style>
    </head>
    <body>

        <div id="view_menu">
            <a id="view_lobby_button" onclick="view('view_lobby');">Lobby</a><a id="view_cards_button" onclick="view('view_cards');">Cards</a><a id="view_game_button" onclick="view('view_game');">Game</a><a id="view_settings_button" onclick="view('view_settings');">Settings</a>
        </div>

        <div class="view" id="view_login">
            <div class="login">
                <h1><img src="logo.png" alt="ManaClash"/></h1>
                <div id="login">
                    <center>
                    <table>
                    <tr><td>Username:</td><td><input id="username" name="username" /></td>
                    <tr><td>Password:</td><td><input id="password" name="password" type="password"/></td>
                    <tr><td colspan="2"><center><button onclick="login();">Login</button></center></td></tr>
                    </table>
                    </center>
                </div>
            </div>
        </div>

        <div class="view" id="view_lobby">

            <div class="view_margin">

            <h3>Lobby</h3>

            <div id="lobby_buttons">
                <button id="lobby_random_duel" onclick="lobbyRandomDuel();">Random Duel</button>
            </div>

            <h3>Users</h3>
            <div id="userlist"></div>

            <h3>Tables</h3>
            <div id="gameslist"></div>

            <div id="lobby_chat">
                <div id="lobby_chat_messages"></div>
                <div id="lobby_chat_form">
                    <input size=60" id="lobby_chat_input" name="lobby_chat_input" /> <button id="lobby_chat_send" onclick="lobbyChatSend();">Send</button>
                </div>
            </div>

            </div>

        </div>

        <div class="view" id="view_game">
            <div id="autopass"><span>3</span></div>

            <div id="status">
                <div id="opponent">
                    <h3 id="opponent_header"><span id="opponent_name"></span> <span id="opponent_life"></span></h3>
                    <div><span id="opponent_manapool"></span></div>
                    <div id="opponent_hand_zone_button" onclick="showZone($('#opponent_hand_zone'));"><span id="opponent_hand"></span></div>

                    <div id="opponent_library_graveyard" class="library_graveyard">
                        <span class="library" id="opponent_library" onclick="showZone($('#opponent_library_zone'));"></span>
                        <span class="graveyard" id="opponent_graveyard" onclick="showZone($('#opponent_graveyard_zone'));"></span>
                    </div>
                </div>

                <div id="player">
                    <h3 id="player_header"><span id="player_name"></span> <span id="player_life"></span></h3>
                    <div><span id="player_manapool"></span></div>

                    <div id="player_library_graveyard" class="library_graveyard">
                        <span class="library" id="player_library" onclick="showZone($('#player_library_zone'));"></span>
                        <span class="graveyard" id="player_graveyard" onclick="showZone($('#player_graveyard_zone'));"></span>
                    </div>
                </div>

                <div>Turn: <span id="turn"></span></div>
                <div>Phase: <span id="phase"></span></div>
                <div>Step: <span id="step"></span></div>

                <div id="text"></div>

<!--                <div><button id="timer">Auto Pass</button></div>-->
                <div><button id="pass" onclick="onPass();">Pass</button></div>

                <div id="actions">
                    <button class="action_button">Action 1</button>
                    <button class="action_button">Action 2</button>
                    <button class="action_button">Action 2</button>
                </div>

                <div id="query">
                    <div id="query_text"></div>
                    <input id="query_input"/>
                    <div>
                        <button id="query_button">Answer</button>
                    </div>
                </div>

                <div id="card_details">
                </div>

            </div>

            <div id="table">
            </div>

            <div id="game_messages">
                <div id="messages">
                    <div id="message">foo</div>
                    <div id="message">foo</div>
                    <div id="message">foo</div>
                    <div id="message">foo</div>
                    <div id="message">foo</div>
                </div>
                <div id="game_messages_form">
                    <input size="60" id="game_messages_input" name="game_messages_input" /> <button id="game_messages_send">Send</button> <button id="game_messages_expand">^</button> <button onclick="endGame();">End Game</button>
                </div>
            </div>

            <div id="zones">
                <button id="zones_hide" onclick="showZone(null);">X</button>
                <div class="zone" id="player_graveyard_zone"></div>
                <div class="zone" id="player_library_zone"></div>
                <div class="zone" id="opponent_graveyard_zone"></div>
                <div class="zone" id="opponent_library_zone"></div>
                <div class="zone" id="opponent_hand_zone"></div>
            </div>
        </div>

        <div class="view" id="view_cards">

            <div class="view_margin">           
 
            <div>
                <select id="cards_decks" onchange="cardsSelectDeck();"></select>
            </div>
            <div>
                <input id="cards_deckname"/> <button onclick="cardsDeckNew();">New</button> <button onclick="cardsDeckRename();">Rename</button> <button onclick="cardsDeckDelete();">Delete</button>
            </div>

            <select id="cards_available" multiple="multiple" onchange="cardsAvailableChanged();"></select>
            <div id="cards_buttons">
                <button onclick="cardsRemove();">&lt;&lt;</button> <button onclick="cardsAdd();">&gt;&gt;</button>
            </div>
            <select id="cards_deck" multiple="multiple" onchange="cardsDeckChanged();"></select>
            <div id="cards_detail">
            </div>

            </div>
        </div>

        <div class="view" id="view_settings">

            <div class="view_margin">

            <h3>Settings</h3>

            <div>
                <div>
                    <div>Card Images URL prefix</div>
                    <div><input id="settings_imgprefix" name="settings_imgprefix"/></div>
                </div>

                <div>
                    <button id="settings_save" name="settings_save" onclick="settingsSave();">Save</button>
                </div>
            </div>

            </div>
        </div>
    </body>
</html>
