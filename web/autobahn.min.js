/*
 AutobahnJS - http://autobahn.ws

 Copyright 2011, 2012 Tavendo GmbH.
 Licensed under the MIT License.
 See license text at http://www.opensource.org/licenses/mit-license.php

 AutobahnJS includes code from:
 when - http://cujojs.com

 (c) copyright B Cavalier & J Hann
 Licensed under the MIT License at:
 http://www.opensource.org/licenses/mit-license.php
*/
/*
 MIT License (c) copyright B Cavalier & J Hann */
(function(a){a(function(){function a(){}function d(){}function e(a){var b=new d;b.then=function(b){f(arguments);var d;try{return b&&(d=b(a)),h(d===m?a:d)}catch(e){return c(e)}};return k(b)}function c(a){var b=new d;b.then=function(b,d){f(arguments);var e;try{return d?(e=d(a),h(e===m?a:e)):c(a)}catch(v){return c(v)}};return k(b)}function f(a){for(var b,c=a.length;c;)if(b=a[--c],null!=b&&"function"!=typeof b)throw Error("callback is not a function");}function n(){var a,b,q,r,g,u,h;q=[];r=[];g=function(a,
b,c){f(arguments);var d=n();q.push(function(c){c.then(a,b).then(d.resolve,d.reject,d.progress)});c&&r.push(c);return d.promise};u=function(a){for(var b,c=0;b=r[c++];)b(a)};h=function(a){var b,c=0;g=a.then;h=u=function(){throw Error("already completed");};for(r=m;b=q[c++];)b(a);q=[]};a={};b=new d;b.then=a.then=function(a,b,c){return g(a,b,c)};a.promise=k(b);a.resolver=k({resolve:a.resolve=function(a){h(e(a))},reject:a.reject=function(a){h(c(a))},progress:a.progress=function(a){u(a)}});return a}function s(a){return a&&
"function"===typeof a.then}function g(a,b,c,d){return h(a).then(b,c,d)}function h(a){var b;a instanceof d||(b=n(),s(a)?a.then(b.resolve,b.reject,b.progress):b.resolve(a),a=b.promise);return a}function i(c,d,e,f,w){function h(a){l(a)}function s(a){o(a)}function k(a){t(a)}var i,j,p,l,o,t,m;m=c.length>>>0;i=Math.max(0,Math.min(d,m));j=[];p=n();d=g(p,e,f,w);if(i){l=function(c){j.push(c);--i||(l=o=t=a,p.resolve(j))};o=function(c){l=o=t=a;p.reject(c)};t=p.progress;for(e=0;e<m;++e)e in c&&g(c[e],h,s,k)}else p.resolve(j);
return d}function l(a,b,c){a[c]=b;return a}function j(a,b,c){var d,e;d=a.length;e=[function(a,c,e){return g(a,function(a){return g(c,function(c){return b(a,c,e,d)})})}];3<=arguments.length&&e.push(c);return h(o.apply(a,e))}var k,o,m;k=Object.freeze||function(a){return a};o=[].reduce||function(a){var b,c,d,e,f;f=0;b=Object(this);e=b.length>>>0;c=arguments;if(1>=c.length)for(;;){if(f in b){d=b[f++];break}if(++f>=e)throw new TypeError;}else d=c[1];for(;f<e;++f)f in b&&(d=a(d,b[f],f,b));return d};g.defer=
n;g.isPromise=s;g.some=i;g.all=function(a,b,c,d){a=j(a,l,Array(a.length));return g(a,b,c,d)};g.any=function(a,b,c,d){return i(a,1,function(a){return b(a[0])},c,d)};g.reduce=j;g.map=function(a,b){var c,d;d=a.length;for(c=Array(d);0<=d;--d)d in a&&(c[d]=g(a[d],b));return j(c,l,c)};g.chain=function(a,b,d){var e=2<arguments.length;return g(a,function(a){e&&(a=d);b.resolve(a);return a},function(a){b.reject(a);return c(a)},b.progress)};return g})})("function"==typeof define?define:function(a){"undefined"!=
typeof module?module.exports=a():this.when=a()});/*
 MIT License (c) 2011,2012 Copyright Tavendo GmbH. */
var AUTOBAHNJS_VERSION="0.7.0",AUTOBAHNJS_DEBUG=!1,ab=window.ab={};ab._version=AUTOBAHNJS_VERSION;
(function(){Array.prototype.indexOf||(Array.prototype.indexOf=function(a){if(null===this)throw new TypeError;var b=Object(this),d=b.length>>>0;if(0===d)return-1;var e=0;0<arguments.length&&(e=Number(arguments[1]),e!==e?e=0:0!==e&&Infinity!==e&&-Infinity!==e&&(e=(0<e||-1)*Math.floor(Math.abs(e))));if(e>=d)return-1;for(e=0<=e?e:Math.max(d-Math.abs(e),0);e<d;e++)if(e in b&&b[e]===a)return e;return-1});Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var d,e;if(this===null)throw new TypeError(" this is null or not defined");
var c=Object(this),f=c.length>>>0;if({}.toString.call(a)!=="[object Function]")throw new TypeError(a+" is not a function");b&&(d=b);for(e=0;e<f;){var n;if(e in c){n=c[e];a.call(d,n,e,c)}e++}})})();ab._sliceUserAgent=function(a,b,d){var e=[],c=navigator.userAgent,a=c.indexOf(a),b=c.indexOf(b,a);0>b&&(b=c.length);d=c.slice(a,b).split(d);c=d[1].split(".");for(b=0;b<c.length;++b)e.push(parseInt(c[b],10));return{name:d[0],version:e}};
ab.getBrowser=function(){var a=navigator.userAgent;return-1<a.indexOf("Chrome")?ab._sliceUserAgent("Chrome"," ","/"):-1<a.indexOf("Safari")?ab._sliceUserAgent("Safari"," ","/"):-1<a.indexOf("Firefox")?ab._sliceUserAgent("Firefox"," ","/"):-1<a.indexOf("MSIE")?ab._sliceUserAgent("MSIE",";"," "):null};ab.browserNotSupportedMessage="Browser does not support WebSockets (RFC6455)";ab._idchars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";ab._idlen=16;ab._subprotocol="wamp";
ab._newid=function(){for(var a="",b=0;b<ab._idlen;b+=1)a+=ab._idchars.charAt(Math.floor(Math.random()*ab._idchars.length));return a};ab.log=function(a){if(window.console&&console.log)if(1<arguments.length){console.group("Log Item");for(var b=0;b<arguments.length;b+=1)console.log(arguments[b]);console.groupEnd()}else console.log(arguments[0])};ab._debugrpc=!1;ab._debugpubsub=!1;ab._debugws=!1;
ab.debug=function(a,b){if("console"in window)ab._debugrpc=a,ab._debugpubsub=a,ab._debugws=b;else throw"browser does not support console object";};ab.version=function(){return ab._version};ab.PrefixMap=function(){this._index={};this._rindex={}};ab.PrefixMap.prototype.get=function(a){return this._index[a]};ab.PrefixMap.prototype.set=function(a,b){this._index[a]=b;this._rindex[b]=a};ab.PrefixMap.prototype.setDefault=function(a){this._index[""]=a;this._rindex[a]=""};
ab.PrefixMap.prototype.remove=function(a){var b=this._index[a];b&&(delete this._index[a],delete this._rindex[b])};ab.PrefixMap.prototype.resolve=function(a,b){var d=a.indexOf(":");if(0<=d){var e=a.substring(0,d);if(this._index[e])return this._index[e]+a.substring(d+1)}return!0==b?a:null};ab.PrefixMap.prototype.shrink=function(a,b){for(var d=a.length;0<d;d-=1){var e=this._rindex[a.substring(0,d)];if(e)return e+":"+a.substring(d)}return!0==b?a:null};ab._MESSAGE_TYPEID_WELCOME=0;
ab._MESSAGE_TYPEID_PREFIX=1;ab._MESSAGE_TYPEID_CALL=2;ab._MESSAGE_TYPEID_CALL_RESULT=3;ab._MESSAGE_TYPEID_CALL_ERROR=4;ab._MESSAGE_TYPEID_SUBSCRIBE=5;ab._MESSAGE_TYPEID_UNSUBSCRIBE=6;ab._MESSAGE_TYPEID_PUBLISH=7;ab._MESSAGE_TYPEID_EVENT=8;ab.CONNECTION_CLOSED=0;ab.CONNECTION_LOST=1;ab.CONNECTION_RETRIES_EXCEEDED=2;ab.CONNECTION_UNREACHABLE=3;ab.CONNECTION_UNSUPPORTED=4;ab.CONNECTION_UNREACHABLE_SCHEDULED_RECONNECT=5;ab.CONNECTION_LOST_SCHEDULED_RECONNECT=6;ab._Deferred=when.defer;
ab.Session=function(a,b,d,e){var c=this;c._wsuri=a;c._options=e;c._websocket_onopen=b;c._websocket_onclose=d;c._websocket=null;c._websocket_connected=!1;c._session_id=null;c._wamp_version=null;c._server=null;c._calls={};c._subscriptions={};c._prefixes=new ab.PrefixMap;c._txcnt=0;c._rxcnt=0;if("WebSocket"in window)c._websocket=new WebSocket(c._wsuri,[ab._subprotocol]);else if("MozWebSocket"in window)c._websocket=new MozWebSocket(c._wsuri,[ab._subprotocol]);else{if(void 0!==d){d(ab.CONNECTION_UNSUPPORTED);
return}throw ab.browserNotSupportedMessage;}c._websocket.onmessage=function(a){ab._debugws&&(c._rxcnt+=1,console.group("WS Receive"),console.info(c._wsuri+"  ["+c._session_id+"]"),console.log(c._rxcnt),console.log(a.data),console.groupEnd());a=JSON.parse(a.data);if(a[1]in c._calls){if(a[0]===ab._MESSAGE_TYPEID_CALL_RESULT){var b=c._calls[a[1]],d=a[2];if(ab._debugrpc&&void 0!==b._ab_callobj){console.group("WAMP Call",b._ab_callobj[2]);console.timeEnd(b._ab_tid);console.group("Arguments");for(var e=
3;e<b._ab_callobj.length;e+=1){var h=b._ab_callobj[e];if(void 0!==h)console.log(h);else break}console.groupEnd();console.group("Result");console.log(d);console.groupEnd();console.groupEnd()}b.resolve(d)}else if(a[0]===ab._MESSAGE_TYPEID_CALL_ERROR){b=c._calls[a[1]];d=a[2];e=a[3];h=a[4];if(ab._debugrpc&&void 0!==b._ab_callobj){console.group("WAMP Call",b._ab_callobj[2]);console.timeEnd(b._ab_tid);console.group("Arguments");for(var i=3;i<b._ab_callobj.length;i+=1){var l=b._ab_callobj[i];if(void 0!==
l)console.log(l);else break}console.groupEnd();console.group("Error");console.log(d);console.log(e);void 0!==h&&console.log(h);console.groupEnd();console.groupEnd()}void 0!==h?b.reject({uri:d,desc:e,detail:h}):b.reject({uri:d,desc:e})}delete c._calls[a[1]]}else if(a[0]===ab._MESSAGE_TYPEID_EVENT){if(b=c._prefixes.resolve(a[1],!0),b in c._subscriptions){var j=a[1],k=a[2];ab._debugpubsub&&(console.group("WAMP Event"),console.info(c._wsuri+"  ["+c._session_id+"]"),console.log(j),console.log(k),console.groupEnd());
c._subscriptions[b].forEach(function(a){a(j,k)})}}else if(a[0]===ab._MESSAGE_TYPEID_WELCOME)if(null===c._session_id){c._session_id=a[1];c._wamp_version=a[2];c._server=a[3];if(ab._debugrpc||ab._debugpubsub)console.group("WAMP Welcome"),console.info(c._wsuri+"  ["+c._session_id+"]"),console.log(c._wamp_version),console.log(c._server),console.groupEnd();null!==c._websocket_onopen&&c._websocket_onopen()}else throw"protocol error (welcome message received more than once)";};c._websocket.onopen=function(){if(c._websocket.protocol!==
ab._subprotocol)if("undefined"===typeof c._websocket.protocol)ab._debugws&&(console.group("WS Warning"),console.info(c._wsuri),console.log("WebSocket object has no protocol attribute: WAMP subprotocol check skipped!"),console.groupEnd());else if(c._options&&c._options.skipSubprotocolCheck)ab._debugws&&(console.group("WS Warning"),console.info(c._wsuri),console.log("Server does not speak WAMP, but subprotocol check disabled by option!"),console.log(c._websocket.protocol),console.groupEnd());else throw c._websocket.close(1E3,
"server does not speak WAMP"),"server does not speak WAMP (but '"+c._websocket.protocol+"' !)";ab._debugws&&(console.group("WAMP Connect"),console.info(c._wsuri),console.log(c._websocket.protocol),console.groupEnd());c._websocket_connected=!0};c._websocket.onerror=function(){};c._websocket.onclose=function(a){ab._debugws&&(c._websocket_connected?console.log("Autobahn connection to "+c._wsuri+" lost (code "+a.code+", reason '"+a.reason+"', wasClean "+a.wasClean+")."):console.log("Autobahn could not connect to "+
c._wsuri+" (code "+a.code+", reason '"+a.reason+"', wasClean "+a.wasClean+")."));void 0!==c._websocket_onclose&&(c._websocket_connected?a.wasClean?c._websocket_onclose(ab.CONNECTION_CLOSED):c._websocket_onclose(ab.CONNECTION_LOST):c._websocket_onclose(ab.CONNECTION_UNREACHABLE));c._websocket_connected=!1;c._wsuri=null;c._websocket_onopen=null;c._websocket_onclose=null;c._websocket=null}};
ab.Session.prototype._send=function(a){if(!this._websocket_connected)throw"Autobahn not connected";a=JSON.stringify(a);this._websocket.send(a);this._txcnt+=1;ab._debugws&&(console.group("WS Send"),console.info(this._wsuri+"  ["+this._session_id+"]"),console.log(this._txcnt),console.log(a),console.groupEnd())};ab.Session.prototype.close=function(){this._websocket_connected&&this._websocket.close()};ab.Session.prototype.sessionid=function(){return this._session_id};
ab.Session.prototype.shrink=function(a,b){void 0===b&&(b=!0);return this._prefixes.shrink(a,b)};ab.Session.prototype.resolve=function(a,b){void 0===b&&(b=!0);return this._prefixes.resolve(a,b)};ab.Session.prototype.prefix=function(a,b){this._prefixes.set(a,b);if(ab._debugrpc||ab._debugpubsub)console.group("WAMP Prefix"),console.info(this._wsuri+"  ["+this._session_id+"]"),console.log(a),console.log(b),console.groupEnd();this._send([ab._MESSAGE_TYPEID_PREFIX,a,b])};
ab.Session.prototype.call=function(){for(var a=new ab._Deferred,b;!(b=ab._newid(),!(b in this._calls)););this._calls[b]=a;for(var d=this._prefixes.shrink(arguments[0],!0),d=[ab._MESSAGE_TYPEID_CALL,b,d],e=1;e<arguments.length;e+=1)d.push(arguments[e]);this._send(d);ab._debugrpc&&(a._ab_callobj=d,a._ab_tid=this._wsuri+"  ["+this._session_id+"]["+b+"]",console.time(a._ab_tid),console.info());return a};
ab.Session.prototype.subscribe=function(a,b){var d=this._prefixes.resolve(a,!0);d in this._subscriptions||(ab._debugpubsub&&(console.group("WAMP Subscribe"),console.info(this._wsuri+"  ["+this._session_id+"]"),console.log(a),console.log(b),console.groupEnd()),this._send([ab._MESSAGE_TYPEID_SUBSCRIBE,a]),this._subscriptions[d]=[]);if(-1===this._subscriptions[d].indexOf(b))this._subscriptions[d].push(b);else throw"callback "+b+" already subscribed for topic "+d;};
ab.Session.prototype.unsubscribe=function(a,b){var d=this._prefixes.resolve(a,!0);if(d in this._subscriptions){var e;if(void 0!==b){var c=this._subscriptions[d].indexOf(b);if(-1!==c)e=b,this._subscriptions[d].splice(c,1);else throw"no callback "+b+" subscribed on topic "+d;}else e=this._subscriptions[d].slice(),this._subscriptions[d]=[];0===this._subscriptions[d].length&&(delete this._subscriptions[d],ab._debugpubsub&&(console.group("WAMP Unsubscribe"),console.info(this._wsuri+"  ["+this._session_id+
"]"),console.log(a),console.log(e),console.groupEnd()),this._send([ab._MESSAGE_TYPEID_UNSUBSCRIBE,a]))}else throw"not subscribed to topic "+d;};
ab.Session.prototype.publish=function(){var a=arguments[0],b=arguments[1],d=null,e=null,c=null,f=null;if(3<arguments.length){if(!(arguments[2]instanceof Array))throw"invalid argument type(s)";if(!(arguments[3]instanceof Array))throw"invalid argument type(s)";e=arguments[2];c=arguments[3];f=[ab._MESSAGE_TYPEID_PUBLISH,a,b,e,c]}else if(2<arguments.length)if("boolean"===typeof arguments[2])d=arguments[2],f=[ab._MESSAGE_TYPEID_PUBLISH,a,b,d];else if(arguments[2]instanceof Array)e=arguments[2],f=[ab._MESSAGE_TYPEID_PUBLISH,
a,b,e];else throw"invalid argument type(s)";else f=[ab._MESSAGE_TYPEID_PUBLISH,a,b];ab._debugpubsub&&(console.group("WAMP Publish"),console.info(this._wsuri+"  ["+this._session_id+"]"),console.log(a),console.log(b),null!==d?console.log(d):null!==e&&(console.log(e),null!==c&&console.log(c)),console.groupEnd());this._send(f)};
ab._connect=function(a){var b=new ab.Session(a.wsuri,function(){a.connects+=1;a.retryCount=0;a.onConnect(b)},function(b){switch(b){case ab.CONNECTION_CLOSED:a.onHangup(b,"Connection was closed properly - done.");break;case ab.CONNECTION_UNSUPPORTED:a.onHangup(b,"Browser does not support WebSocket.");break;case ab.CONNECTION_UNREACHABLE:a.retryCount+=1;if(0==a.connects)a.onHangup(b,"Connection could not be established.");else if(a.retryCount<=a.options.maxRetries)(b=a.onHangup(ab.CONNECTION_UNREACHABLE_SCHEDULED_RECONNECT,
"Connection unreachable - scheduled reconnect to occur in "+a.options.retryDelay/1E3+" second(s).",{delay:a.options.retryDelay,retries:a.retryCount,maxretries:a.options.maxRetries}))?(console.log("Connection unreachable - retrying stopped by app"),a.onHangup(ab.CONNECTION_RETRIES_EXCEEDED,"Number of connection retries exceeded.")):(console.log("Connection unreachable - retrying ("+a.retryCount+") .."),window.setTimeout(ab._connect,a.options.retryDelay,a));else a.onHangup(ab.CONNECTION_RETRIES_EXCEEDED,
"Number of connection retries exceeded.");break;case ab.CONNECTION_LOST:a.retryCount+=1;if(a.retryCount<=a.options.maxRetries)(b=a.onHangup(ab.CONNECTION_LOST_SCHEDULED_RECONNECT,"Connection lost - scheduled reconnect to occur in "+a.options.retryDelay/1E3+" second(s).",{delay:a.options.retryDelay,retries:a.retryCount,maxretries:a.options.maxRetries}))?(console.log("Connection lost - retrying stopped by app"),a.onHangup(ab.CONNECTION_RETRIES_EXCEEDED,"Connection lost.")):(console.log("Connection lost - retrying ("+
a.retryCount+") .."),window.setTimeout(ab._connect,a.options.retryDelay,a));else a.onHangup(ab.CONNECTION_RETRIES_EXCEEDED,"Connection lost.");break;default:throw"unhandled close code in ab._connect";}},a.options)};
ab.connect=function(a,b,d,e){peer={};peer.wsuri=a;peer.options=e?e:{};void 0==peer.options.retryDelay&&(peer.options.retryDelay=5E3);void 0==peer.options.maxRetries&&(peer.options.maxRetries=10);void 0==peer.options.skipSubprotocolCheck&&(peer.options.skipSubprotocolCheck=!1);if(b)peer.onConnect=b;else throw"onConnect handler required!";peer.onHangup=d?d:function(a,b){console.log(b)};peer.connects=0;peer.retryCount=0;ab._connect(peer)};ab._UA_FIREFOX=/.*Firefox\/([0-9+]*).*/;ab._UA_CHROME=/.*Chrome\/([0-9+]*).*/;ab._UA_CHROMEFRAME=/.*chromeframe\/([0-9]*).*/;ab._UA_WEBKIT=/.*AppleWebKit\/([0-9+.]*)w*.*/;ab._UA_WEBOS=/.*webOS\/([0-9+.]*)w*.*/;ab._matchRegex=function(a,b){var d=b.exec(a);return d?d[1]:d};
ab.lookupWsSupport=function(){var a=navigator.userAgent;if(-1<a.indexOf("MSIE")){if(-1<a.indexOf("MSIE 10"))return[!0,!0,!0];if(-1<a.indexOf("chromeframe")){var b=parseInt(ab._matchRegex(a,ab._UA_CHROMEFRAME));return 14<=b?[!0,!1,!0]:[!1,!1,!1]}if(-1<a.indexOf("MSIE 8")||-1<a.indexOf("MSIE 9"))return[!0,!0,!0]}else{if(-1<a.indexOf("Firefox")){if(b=parseInt(ab._matchRegex(a,ab._UA_FIREFOX))){if(7<=b)return[!0,!1,!0];if(3<=b)return[!0,!0,!0]}return[!1,!1,!0]}if(-1<a.indexOf("Safari")&&-1==a.indexOf("Chrome")){if(b=
ab._matchRegex(a,ab._UA_WEBKIT))return-1<a.indexOf("Windows")&&"534+"==b||-1<a.indexOf("Macintosh")&&(b=b.replace("+","").split("."),535==parseInt(b[0])&&24<=parseInt(b[1])||535<parseInt(b[0]))?[!0,!1,!0]:-1<a.indexOf("webOS")?(b=ab._matchRegex(a,ab._UA_WEBOS).split("."),2==parseInt(b[0])?[!1,!0,!0]:[!1,!1,!1]):[!0,!0,!0]}else if(-1<a.indexOf("Chrome")){if(b=parseInt(ab._matchRegex(a,ab._UA_CHROME)))return 14<=b?[!0,!1,!0]:4<=b?[!0,!0,!0]:[!1,!1,!0]}else if(-1<a.indexOf("Android")){if(-1<a.indexOf("Firefox")||
-1<a.indexOf("CrMo"))return[!0,!1,!0];if(-1<a.indexOf("Opera"))return[!1,!1,!0];if(-1<a.indexOf("CrMo"))return[!0,!0,!0]}else if(-1<a.indexOf("iPhone")||-1<a.indexOf("iPad")||-1<a.indexOf("iPod"))return[!1,!1,!0]}return[!1,!1,!1]};
